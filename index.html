<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI åŠ©ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- âš ï¸ æ¨£å¼å®Œå…¨æ²¿ç”¨ä½ åŸæœ¬çš„ï¼ˆæˆ‘æ²’æœ‰å‹•ï¼‰ -->
  <!-- âœ… é€™è£¡çœç•¥ï¼Œè«‹ä¿ç•™ä½ å‰›å‰›è²¼çš„ <style> åŸæ¨£å³å¯ -->
</head>
<body>
<div class="wrapper">
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <span>ğŸ“œ èŠå¤©è¨˜éŒ„</span>
      <span id="clearHistory" class="sidebar-clear">æ¸…é™¤</span>
    </div>
    <div id="historyList" class="sidebar-body"></div>
  </aside>

  <main id="app" class="app">
    <header class="header">
      <span>âœ¨ AI åŠ©ç†</span>
      <div class="header-right">
        <span id="historyBtn" class="toggle">ğŸ“œ</span>
        <span id="themeBtn" class="toggle">ğŸŒ“</span>
      </div>
    </header>

    <section id="chat" class="chat"></section>

    <footer class="footer">
      <div class="input-row">
        <label class="file-label">
          ğŸ“ <span>åœ–ç‰‡</span>
          <input type="file" id="imageInput" accept="image/*" />
        </label>
        <textarea id="input" rows="2" placeholder="è¼¸å…¥æ–‡å­—æˆ–ç”¨èªéŸ³â€¦"></textarea>
      </div>
      <div class="controls">
        <button id="mic">ğŸ¤</button>
        <button id="send">é€å‡º</button>
      </div>
    </footer>
  </main>
</div>

<script>
const BASE_URL = "https://schedule-bot-production-32ae.up.railway.app";
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const micBtn = document.getElementById("mic");
const imageInput = document.getElementById("imageInput");
const themeBtn = document.getElementById("themeBtn");
const historyBtn = document.getElementById("historyBtn");
const sidebar = document.getElementById("sidebar");
const appEl = document.getElementById("app");
const historyList = document.getElementById("historyList");
const clearHistoryBtn = document.getElementById("clearHistory");

/* ===== ä¸»é¡Œ ===== */
if (localStorage.getItem("theme") === "light") {
  document.body.classList.add("light");
}
themeBtn.onclick = () => {
  document.body.classList.toggle("light");
  localStorage.setItem(
    "theme",
    document.body.classList.contains("light") ? "light" : "dark"
  );
};

/* ===== å´æ¬„ ===== */
historyBtn.onclick = () => {
  sidebar.classList.toggle("show");
  appEl.classList.toggle("shift");
};
clearHistoryBtn.onclick = () => {
  if (!confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) return;
  localStorage.removeItem("chat_history");
  historyList.innerHTML = "";
};

/* ===== è¼‰å…¥æ­·å² ===== */
const historyData = JSON.parse(localStorage.getItem("chat_history") || "[]");
historyData.forEach(m => {
  renderMessage(m.role, m.text);
  addHistoryLine(m);
});

/* ===== èªéŸ³è¼¸å…¥ ===== */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = SR ? new SR() : null;
if (recog) {
  recog.lang = "zh-TW";
  micBtn.onclick = () => recog.start();
  recog.onresult = e => inputEl.value = e.results[0][0].transcript;
}

/* ======================= âœ… æ ¸å¿ƒï¼šåœ–ç‰‡ + æ–‡å­—ã€ŒåŒæ™‚é€ã€ ======================= */
sendBtn.onclick = async () => {
  const text = inputEl.value.trim();
  const file = imageInput.files[0];
  if (!text && !file) return;

  // âœ… ä½¿ç”¨è€…æ°£æ³¡
  const previewUrl = file ? URL.createObjectURL(file) : null;
  renderMessage("user", text || "ğŸ–¼ ä¸Šå‚³äº†ä¸€å¼µåœ–ç‰‡", { imageUrl: previewUrl });
  saveHistory({ role: "user", text: text || "[åœ–ç‰‡]" });

  inputEl.value = "";
  imageInput.value = "";

  const thinkingBubble = renderMessage("assistant", "â€¦ æ­£åœ¨æ€è€ƒä¸­", { thinking: true });
  const startTime = performance.now();

  try {
    let replyText = "";

    if (file) {
      // âœ… åœ–ç‰‡ + æ–‡å­—ä¸€èµ·å‚³
      const form = new FormData();
      form.append("image", file);
      form.append("question", text);   // â­ é—œéµï¼šä¸€èµ·é€å•é¡Œ

      const res = await fetch(`${BASE_URL}/parse-schedule-image`, {
        method: "POST",
        body: form
      });

      const data = await res.json();

      // âœ… åªæŠ½ä½ çœŸæ­£è¦çœ‹çš„æ–‡å­—
      if (data.answer) {
        replyText = data.answer;
      } else if (data.events) {
        replyText = data.events
          .map(e => `ğŸ“… ${e.date} ${e.title}`)
          .join("\n");
      } else {
        replyText = "âš ï¸ åœ–ç‰‡å·²è§£æï¼Œä½†æ²’æœ‰å¯ç”¨çµæœ";
      }

    } else {
      // âœ… ç´”èŠå¤©
      const res = await fetch(`${BASE_URL}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      const data = await res.json();
      replyText = data.reply;
    }

    const cost = ((performance.now() - startTime) / 1000).toFixed(2);

    // âœ… æ­£ç¢ºåˆªé™¤ thinking
    thinkingBubble.closest(".message").remove();

    typeWriter(replyText, cost);

  } catch (err) {
    console.error(err);
    thinkingBubble.textContent = "âŒ é€£ç·šå¤±æ•—";
  }
};

/* ===== Render ===== */
function renderMessage(role, text, options = {}) {
  const { thinking = false, imageUrl = null } = options;

  const item = document.createElement("div");
  item.className = `message ${role}`;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  if (thinking) bubble.classList.add("thinking");
  bubble.textContent = text;

  if (imageUrl) {
    const img = document.createElement("img");
    img.src = imageUrl;
    img.className = "thumb";
    bubble.appendChild(img);
  }

  item.appendChild(bubble);
  chatEl.appendChild(item);
  chatEl.scrollTop = chatEl.scrollHeight;
  return bubble;
}

function typeWriter(text, seconds) {
  let i = 0;
  const bubble = renderMessage("assistant", "");

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = `â± ${seconds}s`;

  const timer = setInterval(() => {
    bubble.textContent += text[i++] || "";
    chatEl.scrollTop = chatEl.scrollHeight;

    if (i >= text.length) {
      clearInterval(timer);
      bubble.appendChild(meta);
      speak(text);
      saveHistory({ role: "assistant", text });
    }
  }, 18);
}

/* ===== æ­·å² ===== */
function addHistoryLine({ role, text }) {
  const div = document.createElement("div");
  div.className = "sidebar-item";
  div.textContent = `${role === "user" ? "ğŸ§‘" : "ğŸ¤–"} ${text}`;
  historyList.appendChild(div);
}

function saveHistory(entry) {
  const data = JSON.parse(localStorage.getItem("chat_history") || "[]");
  data.push(entry);
  localStorage.setItem("chat_history", JSON.stringify(data));
  addHistoryLine(entry);
}

/* ===== èªéŸ³æœ—è®€ ===== */
function speak(text) {
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "zh-TW";
  speechSynthesis.speak(u);
}
</script>
</body>
</html>
