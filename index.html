<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI åŠ©ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-dark: linear-gradient(135deg, #020617, #0b1220);
      --bg-light: linear-gradient(135deg, #f8fafc, #e5e7eb);
      --glass-dark: rgba(15,15,20,0.9);
      --glass-light: rgba(255,255,255,0.95);
      --bubble-user: linear-gradient(135deg, #3b82f6, #2563eb);
      --bubble-ai-dark: rgba(31,41,55,0.97);
      --bubble-ai-light: rgba(255,255,255,1);
      --text-dark: #e5e7eb;
      --text-light: #0f172a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      overflow: hidden;
    }

    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    /* ğŸ”¥ æƒæç·š + ç»ç’ƒé›œè¨Šç§‘æŠ€å±¤ */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.03),
          rgba(255,255,255,0.03) 1px,
          transparent 2px,
          transparent 4px
        ),
        linear-gradient(
          to bottom,
          transparent 0%,
          rgba(255,255,255,0.12) 50%,
          transparent 100%
        );
      animation: scan 6s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes scan {
      from { background-position-y: -100%; }
      to   { background-position-y: 100%; }
    }
<body>
<div class="wrapper">

  <!-- ğŸ“œ å´é‚ŠèŠå¤©ç´€éŒ„ -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <span>ğŸ“œ èŠå¤©è¨˜éŒ„</span>
      <span id="clearHistory" class="sidebar-clear">æ¸…é™¤</span>
    </div>
    <div id="historyList" class="sidebar-body"></div>
  </aside>

  <!-- ğŸ’¬ ä¸»èŠå¤©å®¤ -->
  <main id="app" class="app">
    <header class="header">
      <span>âœ¨ AI åŠ©ç†</span>
      <div class="header-right">
        <span id="historyBtn" class="toggle" title="åˆ‡æ›èŠå¤©ç´€éŒ„">ğŸ“œ</span>
        <span id="themeBtn" class="toggle" title="æ·±è‰² / äº®è‰²">ğŸŒ“</span>
        <span id="voiceBtn" class="toggle" title="é–‹é—œèªéŸ³">ğŸ”‡</span> <!-- é è¨­é—œé–‰èªéŸ³ -->
      </div>
    </header>

    <section id="chat" class="chat"></section>

    <footer class="footer">
      <div class="input-row">
        <label class="file-label">
          ğŸ“ <span>åœ–ç‰‡ / PDF</span>
          <input type="file" id="imageInput" accept="image/*,.pdf,application/pdf" />
        </label>
        <textarea id="input" rows="2" placeholder="è¼¸å…¥æ–‡å­—æˆ–ç”¨èªéŸ³â€¦"></textarea>
      </div>
      <div class="controls">
        <button id="mic">ğŸ¤</button>
        <button id="send">é€å‡º</button>
      </div>
    </footer>
  </main>

</div>
<script>
  // ğŸ‘‰ æ”¹æˆä½ çš„ Railway URL
  const BASE_URL = "https://schedule-bot-production-32ae.up.railway.app";

  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const micBtn = document.getElementById("mic");
  const imageInput = document.getElementById("imageInput");
  const themeBtn = document.getElementById("themeBtn");
  const historyBtn = document.getElementById("historyBtn");
  const voiceBtn = document.getElementById("voiceBtn");
  const sidebar = document.getElementById("sidebar");
  const appEl = document.getElementById("app");
  const historyList = document.getElementById("historyList");
  const clearHistoryBtn = document.getElementById("clearHistory");

  /* ========= ä¸»é¡Œåˆ‡æ› ========= */
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
  }
  themeBtn.onclick = () => {
    document.body.classList.toggle("light");
    const mode = document.body.classList.contains("light") ? "light" : "dark";
    localStorage.setItem("theme", mode);
  };

  /* ========= å´æ¬„ ========= */
  historyBtn.onclick = () => {
    sidebar.classList.toggle("show");
    appEl.classList.toggle("shift");
  };

  clearHistoryBtn.onclick = () => {
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è¨˜éŒ„å—ï¼Ÿ")) return;
    localStorage.removeItem("chat_history");
    historyList.innerHTML = "";
    chatEl.innerHTML = "";
  };

  /* ========= è¼‰å…¥æ­·å² ========= */
  const historyData = JSON.parse(localStorage.getItem("chat_history") || "[]");
  historyData.forEach(m => {
    renderMessage(m.role, m.text);
    addHistoryLine(m);
  });

  /* ========= èªéŸ³é–‹é—œï¼ˆé è¨­é—œé–‰æ¨¡å¼ Aï¼‰========= */
  let voiceEnabled = JSON.parse(localStorage.getItem("voice_enabled") ?? "false");
  voiceBtn.textContent = voiceEnabled ? "ğŸ”ˆ" : "ğŸ”‡";

  voiceBtn.onclick = () => {
    voiceEnabled = !voiceEnabled;
    voiceBtn.textContent = voiceEnabled ? "ğŸ”ˆ" : "ğŸ”‡";
    localStorage.setItem("voice_enabled", JSON.stringify(voiceEnabled));
  };

  /* ========= èªéŸ³è¼¸å…¥ï¼ˆSpeechRecognitionï¼‰========= */
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recog = SR ? new SR() : null;

  if (recog) {
    recog.lang = "zh-TW";
    micBtn.onclick = () => recog.start();
    recog.onresult = e => {
      inputEl.value = e.results[0][0].transcript;
    };
  } else {
    micBtn.disabled = true;
  }

  /* ========= é€å‡ºè¨Šæ¯ ========= */
  sendBtn.onclick = async () => {
    const text = inputEl.value.trim();
    const file = imageInput.files[0];

    if (!text && !file) return;

    const previewUrl =
      file && file.type.startsWith("image/") ? URL.createObjectURL(file) : null;

    renderMessage("user", text || (file ? `ğŸ—‚ ä¸Šå‚³æª”æ¡ˆï¼š${file.name}` : ""), {
      imageUrl: previewUrl,
    });

    saveHistory({ role: "user", text: text || `[æª”æ¡ˆ] ${file ? file.name : ""}` });

    inputEl.value = "";
    const thinkingBubble = renderMessage("assistant", "â€¦ æ­£åœ¨æ€è€ƒä¸­", {
      thinking: true,
    });

    const startTime = performance.now();

    try {
      const form = new FormData();
      form.append("message", text);
      if (file) form.append("image", file); // åœ–ç‰‡ or PDF

      const res = await fetch(`${BASE_URL}/chat`, {
        method: "POST",
        body: form,
      });

      if (!res.ok) throw new Error(await res.text());

      const data = await res.json();
      const replyText = data.reply || "";
      const cost = ((performance.now() - startTime) / 1000).toFixed(2);

      thinkingBubble.parentElement.remove();
      typeWriter(replyText, cost);

    } catch (err) {
      console.error(err);
      thinkingBubble.textContent = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";

    } finally {
      imageInput.value = "";
    }
  };

  /* ========= Render / Typewriter ========= */
  function renderMessage(role, text, options = {}) {
    const { thinking = false, imageUrl = null } = options;

    const item = document.createElement("div");
    item.className = `message ${role}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    if (thinking) bubble.classList.add("thinking");
    bubble.textContent = text;

    if (imageUrl) {
      const img = document.createElement("img");
      img.src = imageUrl;
      img.className = "thumb";
      bubble.appendChild(img);
    }

    item.appendChild(bubble);
    chatEl.appendChild(item);
    chatEl.scrollTop = chatEl.scrollHeight;

    return bubble;
  }

  function typeWriter(text, seconds) {
    let i = 0;
    const bubble = renderMessage("assistant", "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `â± å›è¦†æ™‚é–“ï¼š${seconds}s`;

    const timer = setInterval(() => {
      bubble.textContent += text[i++] || "";
      chatEl.scrollTop = chatEl.scrollHeight;

      if (i >= text.length) {
        clearInterval(timer);
        bubble.appendChild(meta);
        speak(text); // âœ æœƒä¾ç…§ voiceEnabled åˆ¤æ–·
        saveHistory({ role: "assistant", text });
      }
    }, 18);
  }

  /* ========= å´æ¬„å„²å­˜ ========= */
  function addHistoryLine({ role, text }) {
    const div = document.createElement("div");
    div.className = "sidebar-item";
    const prefix = role === "user" ? "ğŸ§‘â€ğŸ’»" : "ğŸ¤–";
    div.textContent = `${prefix} ${text}`;
    historyList.appendChild(div);
  }

  function saveHistory(entry) {
    const data = JSON.parse(localStorage.getItem("chat_history") || "[]");
    data.push(entry);
    localStorage.setItem("chat_history", JSON.stringify(data));
    addHistoryLine(entry);
  }

  /* ========= èªéŸ³æœ—è®€ï¼ˆä¾ç…§ voiceEnabledï¼‰========= */
  function speak(text) {
    if (!voiceEnabled) return;
    if (!window.speechSynthesis) return;

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    speechSynthesis.speak(u);
  }
</script>
