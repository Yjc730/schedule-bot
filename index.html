<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>AI åŠ©ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --bg: #f4f4f5;
  --glass: rgba(255,255,255,.82);
  --bubble-user: #2563eb;
  --bubble-ai: #ffffff;
  --text: #111;
}
body.dark {
  --bg: #020617;
  --glass: rgba(20,20,20,.85);
  --bubble-ai: #1f2933;
  --text: #f9fafb;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  height: 100vh;
  font-family: system-ui;
  background: var(--bg);
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  transition: .3s;
}

/* âœ… æƒæç·šå…‰æŸ */
body::after {
  content:"";
  position:fixed;
  inset:0;
  background:linear-gradient(
    to bottom,
    transparent 0%,
    rgba(255,255,255,.15) 50%,
    transparent 100%
  );
  animation:scan 6s linear infinite;
  pointer-events:none;
}
@keyframes scan {
  0% {transform:translateY(-100%)}
  100% {transform:translateY(100%)}
}

/* âœ… æ­·å²æŠ½å±œ */
.history {
  position: fixed;
  left: -260px;
  top: 0;
  width: 260px;
  height: 100vh;
  background: var(--glass);
  backdrop-filter: blur(16px);
  padding: 12px;
  transition: .3s;
  overflow-y: auto;
  z-index: 10;
}
.history.open { left: 0; }
.history h3 { margin: 8px 0; }
.history-item {
  font-size: 13px;
  padding: 6px;
  border-bottom: 1px solid #ccc;
  cursor:pointer;
}

.app {
  width: 100%;
  max-width: 960px;
  height: 94vh;
  margin: 12px;
  border-radius: 24px;
  background: var(--glass);
  backdrop-filter: blur(18px);
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  z-index: 2;
}
.header {
  padding: 14px;
  color: var(--text);
  font-weight: bold;
  text-align: center;
  border-bottom: 1px solid rgba(255,255,255,.3);
  display: flex;
  justify-content: space-between;
}
.toggle { cursor:pointer; }

.chat {
  flex: 1;
  padding: 18px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.message { display:flex; margin-bottom:14px; animation:fadeIn .25s; }
.user { justify-content:flex-end; }
.assistant { justify-content:flex-start; }

.bubble {
  padding: 12px 16px;
  border-radius: 18px;
  max-width: 80%;
  line-height: 1.6;
  box-shadow: 0 6px 20px rgba(0,0,0,.15);
  animation: breathe 3s infinite;
  color: var(--text);
}
.user .bubble { background:var(--bubble-user); color:#fff; border-bottom-right-radius:6px; }
.assistant .bubble { background:var(--bubble-ai); border-bottom-left-radius:6px; }

.thinking { opacity:.6; animation: blink 1.4s infinite; }
.time { font-size:11px; opacity:.6; margin-top:6px; }

.footer {
  padding: 12px;
  border-top: 1px solid rgba(255,255,255,.3);
}
textarea { width:100%; resize:none; padding:10px; border-radius:12px; border:none; }

.controls { display:flex; gap:8px; margin-top:6px; }
button {
  flex:1;
  border:none;
  border-radius:999px;
  padding:10px;
  background:#2563eb;
  color:white;
}
input[type=file]{display:none;}

@keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1} }
@keyframes blink {50%{opacity:1}}
@keyframes breathe {
  0%{box-shadow:0 4px 12px rgba(0,0,0,.2)}
  50%{box-shadow:0 8px 24px rgba(0,0,0,.4)}
  100%{box-shadow:0 4px 12px rgba(0,0,0,.2)}
}
</style>
</head>
<body>

<div id="history" class="history">
  <h3>ğŸ“œ æ­·å²ç´€éŒ„</h3>
  <div id="historyList"></div>
</div>

<div class="app">
  <div class="header">
    <span id="openHistory">ğŸ“œ</span>
    âœ¨ AI åŠ©ç†
    <span id="themeToggle">ğŸŒ“</span>
  </div>

  <div id="chat" class="chat"></div>

  <div class="footer">
    <label>ğŸ“ åœ–ç‰‡ <input type="file" id="image-input"></label>
    <textarea id="input" placeholder="è¼¸å…¥æ–‡å­—æˆ–èªéŸ³â€¦"></textarea>
    <div class="controls">
      <button id="mic">ğŸ¤</button>
      <button id="send">é€å‡º</button>
    </div>
  </div>
</div>

<script>
const BASE_URL = "https://schedule-bot-production-32ae.up.railway.app";
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const micBtn = document.getElementById("mic");
const historyEl = document.getElementById("history");
const historyList = document.getElementById("historyList");

/* âœ… ä¸»é¡Œ */
if (localStorage.theme === "dark") document.body.classList.add("dark");
themeToggle.onclick = () => {
  document.body.classList.toggle("dark");
  localStorage.theme = document.body.classList.contains("dark") ? "dark" : "light";
};

/* âœ… æ­·å²æŠ½å±œ */
openHistory.onclick = () => historyEl.classList.toggle("open");

/* âœ… èªéŸ³è¼¸å…¥ */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SR) {
  const recog = new SR();
  recog.lang = "zh-TW";
  micBtn.onclick = () => recog.start();
  recog.onresult = e => inputEl.value = e.results[0][0].transcript;
}

/* âœ… LocalStorage */
let history = JSON.parse(localStorage.getItem("chat_history") || "[]");
history.forEach(m => render(m.role,m.text));
renderHistory();

sendBtn.onclick = async () => {
  const text = inputEl.value.trim();
  if (!text) return;
  render("user", text);
  save("user", text);
  inputEl.value = "";

  const thinking = render("assistant","â€¦ æ­£åœ¨æ€è€ƒä¸­",true);
  const start = performance.now();

  try {
    const res = await fetch(`${BASE_URL}/chat`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message:text })
    });
    const data = await res.json();
    const cost = ((performance.now()-start)/1000).toFixed(2);
    thinking.remove();
    typeWriter(data.reply,cost);
  } catch {
    thinking.textContent="âŒ é€£ç·šå¤±æ•—";
  }
};

function render(role,text,loading=false){
  const div=document.createElement("div");
  div.className=`message ${role}`;
  const b=document.createElement("div");
  b.className="bubble";
  if(loading) b.classList.add("thinking");
  b.textContent=text;
  div.appendChild(b);
  chatEl.appendChild(div);
  chatEl.scrollTop=chatEl.scrollHeight;
  return b;
}

function typeWriter(text,time){
  const bubble=render("assistant","");
  let i=0;
  const timer=setInterval(()=>{
    bubble.textContent+=text[i++];
    if(i>=text.length){
      clearInterval(timer);
      const t=document.createElement("div");
      t.className="time";
      t.textContent=`â± ${time}s`;
      bubble.appendChild(t);
      speak(text);
      save("assistant",text);
    }
  },18);
}

function save(role,text){
  history.push({role,text});
  localStorage.setItem("chat_history",JSON.stringify(history));
  renderHistory();
}

function renderHistory(){
  historyList.innerHTML="";
  history.forEach(m=>{
    const d=document.createElement("div");
    d.className="history-item";
    d.textContent=m.text;
    historyList.appendChild(d);
  });
}

function speak(text){
  const u=new SpeechSynthesisUtterance(text);
  u.lang="zh-TW";
  speechSynthesis.speak(u);
}
</script>
</body>
</html>
