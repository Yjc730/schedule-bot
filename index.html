<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>AI åŠ©ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg-dark: linear-gradient(135deg, #020617, #0f172a);
  --bg-light: linear-gradient(135deg, #f8fafc, #e5e7eb);
  --panel-dark: rgba(15,15,20,0.92);
  --panel-light: rgba(255,255,255,0.95);
  --user: linear-gradient(135deg, #3b82f6, #2563eb);
  --ai-dark: rgba(31,41,55,.95);
  --ai-light: #ffffff;
  --text-dark: #e5e7eb;
  --text-light: #0f172a;
}

body {
  margin:0;
  height:100vh;
  background:var(--bg-dark);
  color:var(--text-dark);
  font-family:system-ui;
  overflow:hidden;
}
body.light {
  background:var(--bg-light);
  color:var(--text-light);
}

/* ==== ç‰ˆé¢ ==== */
.wrapper {
  display:flex;
  height:100%;
}

/* ==== å´é‚Šæ¬„ ==== */
.sidebar {
  width:260px;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(20px);
  position:absolute;
  left:-260px;
  top:0; bottom:0;
  transition:.3s;
  z-index:20;
  display:flex;
  flex-direction:column;
}
body.light .sidebar{background:#fff;}
.sidebar.show { left:0; }

.sidebar-header {
  padding:14px;
  border-bottom:1px solid rgba(255,255,255,.2);
  display:flex;
  justify-content:space-between;
  font-weight:bold;
}
.sidebar-body {
  flex:1;
  overflow-y:auto;
  padding:12px;
  font-size:13px;
}
.sidebar-item {
  margin-bottom:6px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.sidebar-clear {
  cursor:pointer;
  font-size:12px;
}

/* ==== èŠå¤©å®¤ ==== */
.app {
  flex:1;
  margin:16px;
  border-radius:22px;
  background:var(--panel-dark);
  display:flex;
  flex-direction:column;
  transition:.3s;
}
.app.shift {
  margin-left:300px;
}
body.light .app {
  background:var(--panel-light);
}

/* header */
.header {
  padding:14px;
  border-bottom:1px solid rgba(255,255,255,.2);
  display:flex;
  justify-content:space-between;
}

/* chat */
.chat {
  flex:1;
  padding:18px;
  overflow-y:auto;
}
.msg {
  display:flex;
  margin-bottom:10px;
}
.user { justify-content:flex-end; }
.ai { justify-content:flex-start; }
.bubble {
  max-width:75%;
  padding:10px 14px;
  border-radius:18px;
}
.user .bubble {
  background:var(--user);
  color:white;
}
.ai .bubble {
  background:var(--ai-dark);
}
body.light .ai .bubble {
  background:var(--ai-light);
  color:black;
}

/* footer */
.footer {
  padding:12px;
  border-top:1px solid rgba(255,255,255,.2);
}
.controls {
  display:flex;
  gap:8px;
  margin-top:6px;
}
textarea {
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
}
button {
  flex:1;
  padding:10px;
  border:none;
  border-radius:999px;
  background:#2563eb;
  color:white;
  cursor:pointer;
}
input[type=file] { display:none; }
</style>
</head>

<body>

<div class="wrapper">

  <!-- ğŸ“œ å´é‚Šç´€éŒ„ -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      èŠå¤©ç´€éŒ„
      <span id="clearHistory" class="sidebar-clear">æ¸…é™¤</span>
    </div>
    <div id="historyList" class="sidebar-body"></div>
  </aside>

  <!-- ğŸ’¬ ä¸»èŠå¤©å®¤ -->
  <main id="app" class="app">
    <div class="header">
      âœ¨ AI åŠ©ç†
      <div>
        <span id="historyBtn">ğŸ“œ</span>
        <span id="themeBtn">ğŸŒ“</span>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="footer">
      <label>ğŸ“ åœ–ç‰‡
        <input type="file" id="imageInput" />
      </label>
      <textarea id="input" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
      <div class="controls">
        <button id="send">é€å‡º</button>
      </div>
    </div>
  </main>

</div>

<script>
const BASE_URL = "https://schedule-bot-production-32ae.up.railway.app";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const imageInput = document.getElementById("imageInput");

const sidebar = document.getElementById("sidebar");
const historyBtn = document.getElementById("historyBtn");
const clearHistoryBtn = document.getElementById("clearHistory");
const historyList = document.getElementById("historyList");

const themeBtn = document.getElementById("themeBtn");
const app = document.getElementById("app");

/* === ä¸»é¡Œåˆ‡æ› === */
if(localStorage.getItem("theme")==="light"){
  document.body.classList.add("light");
}
themeBtn.onclick=()=>{
  document.body.classList.toggle("light");
  localStorage.setItem("theme",
    document.body.classList.contains("light")?"light":"dark"
  );
}

/* === å´æ¬„é–‹é—œ === */
historyBtn.onclick=()=>{
  sidebar.classList.toggle("show");
  app.classList.toggle("shift");
}

/* === æ¸…é™¤ç´€éŒ„ === */
clearHistoryBtn.onclick=()=>{
  if(!confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) return;
  localStorage.removeItem("chat_history");
  chat.innerHTML="";
  historyList.innerHTML="";
}

/* === è¼‰å…¥æ­·å² === */
const historyData=JSON.parse(localStorage.getItem("chat_history")||"[]");
historyData.forEach(m=>{
  render(m.role,m.text);
  addHistory(m);
});

/* === é€å‡º === */
sendBtn.onclick=async()=>{
  const text=input.value.trim();
  const file=imageInput.files[0];
  if(!text && !file) return;

  render("user",text||"ä¸Šå‚³åœ–ç‰‡");
  save("user",text||"[åœ–ç‰‡]");
  input.value=""; imageInput.value="";

  const loading=render("ai","æ€è€ƒä¸­...");

  try{
    let reply="";
    if(file){
      const form=new FormData();
      form.append("image",file);
      const res=await fetch(`${BASE_URL}/parse-schedule-image`,{
        method:"POST",body:form
      });
      const data=await res.json();
      reply=JSON.stringify(data,null,2);
    }else{
      const res=await fetch(`${BASE_URL}/chat`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:text})
      });
      const data=await res.json();
      reply=data.reply;
    }
    loading.remove();
    render("ai",reply);
    save("ai",reply);
  }catch{
    loading.textContent="âŒ é€£ç·šå¤±æ•—";
  }
};

/* === UI functions === */
function render(role,text){
  const msg=document.createElement("div");
  msg.className=`msg ${role}`;
  const b=document.createElement("div");
  b.className="bubble";
  b.textContent=text;
  msg.appendChild(b);
  chat.appendChild(msg);
  chat.scrollTop=chat.scrollHeight;
  return b;
}

function save(role,text){
  const data=JSON.parse(localStorage.getItem("chat_history")||"[]");
  data.push({role,text});
  localStorage.setItem("chat_history",JSON.stringify(data));
  addHistory({role,text});
}

function addHistory({role,text}){
  const div=document.createElement("div");
  div.className="sidebar-item";
  div.textContent=(role==="user"?"ğŸ§‘":"ğŸ¤–")+" "+text;
  historyList.appendChild(div);
}
</script>

</body>
</html>
