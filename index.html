<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI åŠ©ç† Â· AI Lab Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1220;
      --panel: rgba(15, 23, 42, 0.72);
      --panel2: rgba(2, 6, 23, 0.55);
      --border: rgba(148,163,184,0.28);
      --text:#e5e7eb;
      --muted: rgba(226,232,240,0.7);

      --aqua:#22d3ee;
      --violet:#a78bfa;
      --blue:#60a5fa;

      --userGrad: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.95));
      --aiBg: rgba(31,41,55,0.92);

      --shadow: 0 26px 90px rgba(0,0,0,0.55);
      --shadow2: 0 14px 40px rgba(0,0,0,0.35);

      --radius: 22px;
      --radius2: 16px;
    }

    /* Light theme */
    body.light{
      --bg0:#f8fafc;
      --bg1:#e5e7eb;
      --panel: rgba(255,255,255,0.72);
      --panel2: rgba(255,255,255,0.55);
      --border: rgba(15,23,42,0.12);
      --text:#0f172a;
      --muted: rgba(15,23,42,0.62);

      --aiBg: rgba(255,255,255,0.95);
      --shadow: 0 22px 70px rgba(15,23,42,0.12);
      --shadow2: 0 10px 28px rgba(15,23,42,0.10);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      overflow:hidden;
      background: radial-gradient(1200px 700px at 18% 20%, rgba(34,211,238,0.14), transparent 55%),
                  radial-gradient(1000px 650px at 85% 35%, rgba(167,139,250,0.13), transparent 55%),
                  linear-gradient(135deg, var(--bg0), var(--bg1));
    }

    /* Calm cyber layers (SLOW) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        linear-gradient(transparent 0%, rgba(255,255,255,0.05) 50%, transparent 100%),
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.025),
          rgba(255,255,255,0.025) 1px,
          transparent 2px,
          transparent 6px
        );
      opacity:0.45;
      animation: drift 22s linear infinite; /* âœ… æ…¢å¾ˆå¤š */
      transform: translateZ(0);
    }

    body::after{
      content:"";
      position:fixed;
      inset:-20%;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(circle at 20% 25%, rgba(34,211,238,0.08), transparent 40%),
        radial-gradient(circle at 80% 35%, rgba(167,139,250,0.08), transparent 42%),
        radial-gradient(circle at 50% 80%, rgba(96,165,250,0.06), transparent 45%);
      filter: blur(18px);
      animation: breathe 16s ease-in-out infinite; /* âœ… å¾ˆæŸ” */
      transform: translateZ(0);
      opacity: 0.7;
    }

    @keyframes drift{
      0%{ background-position-y: -60%; }
      100%{ background-position-y: 60%; }
    }
    @keyframes breathe{
      0%{ transform: translate3d(0,0,0) scale(1); opacity:0.62; }
      50%{ transform: translate3d(0,-8px,0) scale(1.02); opacity:0.75; }
      100%{ transform: translate3d(0,0,0) scale(1); opacity:0.62; }
    }

    .wrapper{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      z-index:1;
    }

    /* Sidebar */
    .sidebar{
      width: 290px;
      position:absolute;
      left:-290px;
      top:0; bottom:0;
      z-index:20;

      background: linear-gradient(180deg, rgba(2,6,23,0.72), rgba(2,6,23,0.55));
      border-right: 1px solid var(--border);
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow2);

      display:flex;
      flex-direction:column;
      transition: left .32s ease;
    }
    body.light .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.62));
    }
    .sidebar.show{ left:0; }

    .sidebar-header{
      padding: 14px 14px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid var(--border);
      gap:10px;
    }
    .sidebar-title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .sidebar-title .t1{
      font-weight: 700;
      letter-spacing: 0.3px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.04);
      width: fit-content;
    }
    body.light .pill{ background: rgba(15,23,42,0.03); }

    .sidebar-clear{
      cursor:pointer;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      user-select:none;
      transition: transform .12s ease, border-color .12s ease;
    }
    .sidebar-clear:hover{
      transform: translateY(-1px);
      border-color: rgba(34,211,238,0.35);
    }

    .sidebar-body{
      flex:1;
      overflow-y:auto;
      padding: 12px 12px 16px;
    }

    .sidebar-item{
      padding: 10px 10px;
      border-radius: 14px;
      margin-bottom: 8px;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(15,23,42,0.28);
      color: var(--text);
      font-size: 12.5px;
      line-height: 1.35;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      cursor: default;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    body.light .sidebar-item{ background: rgba(15,23,42,0.04); }
    .sidebar-item:hover{
      transform: translateY(-1px);
      border-color: rgba(167,139,250,0.35);
      background: rgba(15,23,42,0.34);
    }
    body.light .sidebar-item:hover{ background: rgba(15,23,42,0.06); }

    /* Main App */
    .app{
      flex:1;
      margin: 16px;
      border-radius: var(--radius);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(15,23,42,0.76), rgba(15,23,42,0.56));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(22px);
      display:flex;
      flex-direction:column;
      transition: margin-left .32s ease;
      position:relative;
    }
    body.light .app{
      background: linear-gradient(180deg, rgba(255,255,255,0.76), rgba(255,255,255,0.56));
    }
    .app.shift{ margin-left: 306px; }

    /* Subtle neon frame */
    .app::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: var(--radius);
      padding: 1px;
      background: linear-gradient(135deg,
        rgba(34,211,238,0.35),
        rgba(167,139,250,0.22),
        rgba(96,165,250,0.22)
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      opacity: 0.8;
    }

    /* Header (AI Lab Mode) */
    .header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .brand .title{
      font-weight: 800;
      letter-spacing: 0.3px;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width: 8px; height:8px;
      border-radius:999px;
      background: rgba(34,211,238,0.9);
      box-shadow: 0 0 0 3px rgba(34,211,238,0.12), 0 0 18px rgba(34,211,238,0.45);
      flex: 0 0 auto;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.03);
    }
    body.light .badge{ background: rgba(15,23,42,0.03); }

    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .toggle{
      cursor:pointer;
      user-select:none;
      width: 38px;
      height: 38px;
      display:grid;
      place-items:center;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.03);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      font-size: 18px;
    }
    body.light .toggle{ background: rgba(15,23,42,0.03); }
    .toggle:hover{
      transform: translateY(-1px);
      border-color: rgba(34,211,238,0.35);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.08);
    }
    .toggle.voice-on{
      border-color: rgba(34,211,238,0.45);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.12), 0 0 18px rgba(34,211,238,0.16);
    }

    /* Chat area */
    .chat{
      flex:1;
      padding: 18px 18px 8px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      position:relative;
    }

    .message{
      display:flex;
      margin-bottom: 12px;
      animation: pop .18s ease;
    }
    @keyframes pop{
      from{ opacity:0; transform: translateY(4px); }
      to{ opacity:1; transform:none; }
    }

    .user{ justify-content:flex-end; }
    .assistant{ justify-content:flex-start; }

    .bubble{
      max-width: 78%;
      padding: 12px 14px;
      border-radius: 18px;
      line-height: 1.65;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
      position:relative;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(15,23,42,0.35);
    }

    .user .bubble{
      background: var(--userGrad);
      color: #fff;
      border-bottom-right-radius: 8px;
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 14px 36px rgba(37,99,235,0.18);
    }

    .assistant .bubble{
      background: var(--aiBg);
      color: var(--text);
      border-bottom-left-radius: 8px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.22);
    }

    .bubble .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
      opacity: 0.85;
    }
    .tag .miniDot{
      width:6px;height:6px;border-radius:999px;
      background: rgba(167,139,250,0.9);
      box-shadow: 0 0 0 3px rgba(167,139,250,0.10);
    }

    .thinking{
      opacity: 0.78;
      font-style: italic;
      border-color: rgba(34,211,238,0.22) !important;
      box-shadow: 0 0 0 4px rgba(34,211,238,0.07);
      animation: blink 1.6s ease-in-out infinite;
    }
    @keyframes blink{
      0%,100%{ opacity:0.55; }
      50%{ opacity:0.95; }
    }

    .thumb{
      margin-top: 8px;
      border-radius: 14px;
      max-width: 180px;
      display:block;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 12px 30px rgba(0,0,0,0.22);
    }
    .meta{
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Footer */
    .footer{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
    }
    body.light .footer{
      background: linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.00));
    }

    .input-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .file-label{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      cursor:pointer;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.03);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
    }
    body.light .file-label{ background: rgba(15,23,42,0.03); }
    .file-label:hover{
      transform: translateY(-1px);
      border-color: rgba(167,139,250,0.35);
      box-shadow: 0 0 0 4px rgba(167,139,250,0.08);
    }
    input[type="file"]{ display:none; }

    textarea{
      flex:1;
      resize:none;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.22);
      outline:none;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
      background: rgba(2,6,23,0.30);
      backdrop-filter: blur(12px);
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    body.light textarea{
      background: rgba(255,255,255,0.72);
    }
    textarea.listening {
      border-color: rgba(34,211,238,0.55);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.15);
   }
    textarea:focus{
      border-color: rgba(34,211,238,0.40);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
    }

    .controls{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }

    button{
      flex:1;
      padding: 12px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.18);
      color: #fff;
      font-weight: 800;
      letter-spacing: .3px;
      cursor:pointer;
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.95));
      box-shadow: 0 14px 34px rgba(37,99,235,0.22);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(37,99,235,0.28);
    }
    button:disabled{
      opacity: 0.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    /* Mobile */
    @media (max-width: 768px){
      .app{ margin: 10px; border-radius: 18px; }
      .app.shift{ margin-left: 10px; } /* sidebar è¦†è“‹ */
      .sidebar{
        width: 86%;
        left: -86%;
      }
      .sidebar.show{ left:0; }
    }
  </style>
</head>

<body>
<div class="wrapper">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <div class="t1">Session Log <span class="pill">localStorage</span></div>
        <div class="pill">AI Lab Mode Â· Calm Cyber</div>
      </div>
      <div id="clearHistory" class="sidebar-clear" title="æ¸…é™¤èŠå¤©è¨˜éŒ„">æ¸…é™¤</div>
    </div>
    <div id="historyList" class="sidebar-body"></div>
  </aside>

  <!-- Main -->
  <main id="app" class="app">
    <header class="header">
      <div class="brand">
        <div class="title"><span class="dot"></span> AI Assistant Â· Lab</div>
        <div class="sub">
          <span class="badge">MODEL: Gemini 2.5 Flash</span>
          <span class="badge">STATUS: Online</span>
        </div>
      </div>

      <div class="header-right">
        <div id="historyBtn" class="toggle" title="Session Log">â˜°</div>
        <div id="themeBtn" class="toggle" title="æ·±è‰² / äº®è‰²">ğŸŒ“</div>
        <div id="voiceBtn" class="toggle" title="èªéŸ³æœ—è®€ï¼ˆé è¨­é—œé–‰ï¼‰">ğŸ”‡</div>
      </div>
    </header>

    <section id="chat" class="chat"></section>

    <footer class="footer">
      <div class="input-row">
        <label class="file-label" title="ä¸Šå‚³åœ–ç‰‡ / PDF">
          ğŸ“
          <input
            type="file"
            id="fileInput"
            accept="image/*,.pdf,application/pdf"
            multiple
          />
        </label>
        <textarea id="input" rows="2" placeholder="è¼¸å…¥æ–‡å­—æˆ–ç”¨èªéŸ³â€¦ï¼ˆæ”¯æ´åœ–ç‰‡/PDFï¼‰"></textarea>
      </div>
      <div class="controls">
        <button id="mic" type="button">ğŸ¤ èªéŸ³è¼¸å…¥</button>
        <button id="send" type="button">é€å‡º</button>
      </div>
    </footer>
  </main>
</div>

<script>
  // ğŸ‘‰ è¨˜å¾—æ”¹æˆä½ è‡ªå·±çš„ Railway URL
  const API_BASE_URL = "https://schedule-bot-uzuu.onrender.com";
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const fileInput = document.getElementById("fileInput");
  const defaultPlaceholder = inputEl.placeholder;
  const sendBtn = document.getElementById("send");
  const micBtn = document.getElementById("mic");

  const themeBtn = document.getElementById("themeBtn");
  const voiceBtn = document.getElementById("voiceBtn");
  const historyBtn = document.getElementById("historyBtn");

  const sidebar = document.getElementById("sidebar");
  const appEl = document.getElementById("app");
  const historyList = document.getElementById("historyList");
  const clearHistoryBtn = document.getElementById("clearHistory");

  let pendingVoiceAction = null;

/* =========================
   File input UXï¼ˆé¸æª”æç¤ºï¼‰
========================= */
fileInput.onchange = () => {
  if (fileInput.files.length > 0) {
    inputEl.placeholder =
      `ğŸ“ å·²é¸ ${fileInput.files.length} å€‹æª”æ¡ˆï¼Œå¯ç›´æ¥è¼¸å…¥å•é¡Œ`;
  } else {
    inputEl.placeholder = defaultPlaceholder;
  }
};

  /* =========================
     Theme (ä¿ç•™åŠŸèƒ½)
  ========================= */
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
  }
  themeBtn.onclick = () => {
    document.body.classList.toggle("light");
    localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
  };

  /* =========================
     Sidebar (ä¿ç•™åŠŸèƒ½)
  ========================= */
  historyBtn.onclick = () => {
    sidebar.classList.toggle("show");
    appEl.classList.toggle("shift");
  };

  clearHistoryBtn.onclick = () => {
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è¨˜éŒ„å—ï¼Ÿ")) return;
    localStorage.removeItem("chat_history");
    historyList.innerHTML = "";
    chatEl.innerHTML = "";
  };

  /* =========================
     Voice TTS (æ¨¡å¼ Aï¼šé è¨­é—œé–‰ï¼ŒåªæŒ‰ğŸ”ˆæ‰å”¸)
     âœ… æœƒå­˜ localStorage
     âœ… é—œé–‰æ™‚æœƒ stop speak
  ========================= */
  let voiceEnabled = JSON.parse(localStorage.getItem("voice_enabled") || "false"); // âœ… é è¨­ false
  function syncVoiceUI(){
    voiceBtn.textContent = voiceEnabled ? "ğŸ”ˆ" : "ğŸ”‡";
    voiceBtn.classList.toggle("voice-on", voiceEnabled);
    voiceBtn.title = voiceEnabled ? "èªéŸ³æœ—è®€ï¼šé–‹" : "èªéŸ³æœ—è®€ï¼šé—œï¼ˆé è¨­ï¼‰";
  }
  syncVoiceUI();

  voiceBtn.onclick = () => {
    voiceEnabled = !voiceEnabled;
    localStorage.setItem("voice_enabled", JSON.stringify(voiceEnabled));
    if (!voiceEnabled && window.speechSynthesis) {
      window.speechSynthesis.cancel();
    }
    syncVoiceUI();
  };

  /* =========================
   Speech Recognition (èªéŸ³è¼¸å…¥)
========================= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = SR ? new SR() : null;



if (!navigator.mediaDevices || !recog) {
  micBtn.disabled = true;
  micBtn.textContent = "ğŸ¤ ä¸æ”¯æ´èªéŸ³";
}
  
let isListening = false;
let lastTranscript = "";

function resetMicUI() {
  isListening = false;
  lastTranscript = "";

  micBtn.textContent = "ğŸ¤ èªéŸ³è¼¸å…¥";
  micBtn.classList.remove("voice-on");
  sendBtn.disabled = false;

  inputEl.placeholder = defaultPlaceholder;
  inputEl.classList.remove("listening");

  // â­ é—œéµï¼šç¢ºèªä¸­å°±ä¸è¦é‡ç½®
  if (pendingVoiceAction) return;
}



if (recog) {
  recog.lang = "zh-TW";
  recog.interimResults = false;
  recog.maxAlternatives = 1;

  recog.onstart = () => {
    console.log("ğŸ¤ recognition STARTED");
  };
  
  // ğŸ¤ é»æ“Šéº¥å…‹é¢¨ï¼šé–‹å§‹ / åœæ­¢
  micBtn.onclick = () => {
    if (pendingVoiceAction) {
  renderMessage("assistant", "è«‹ç›´æ¥èªªã€Œå°ã€æˆ–ã€Œå–æ¶ˆã€");
  return;
}
    if (!isListening) {
      try {
        recog.start();
        isListening = true;
        micBtn.textContent = "ğŸ›‘ åœæ­¢èªéŸ³";
        micBtn.classList.add("voice-on");
        sendBtn.disabled = true;   // â­ æ–°å¢

        // â­ Listening UI
        inputEl.placeholder = "ğŸ™ Listeningâ€¦";
        inputEl.classList.add("listening");
        
      } catch (e) {
        console.warn("Speech start error", e);
      }
    } else {
      recog.stop();
    }
  };



  function isActionCommand(text){
    const keywords = [
      "å¯„ä¿¡", "å¹«æˆ‘å¯„", "å¯«ä¿¡çµ¦", "å¯„ä¸€å°ä¿¡",
      "é–‹outlook", "é–‹ä¿¡"
    ];
    return keywords.some(k => text.includes(k));
  }
  // =========================
// âœ… èªéŸ³é€å‡ºï¼ˆè·ŸæŒ‰ã€Œé€å‡ºã€å…±ç”¨é‚è¼¯ï¼‰
// =========================
async function smartSend(text) {
  // é¡¯ç¤ºä½¿ç”¨è€…èªªçš„è©±
  renderMessage("user", text);
  saveHistory({ role: "user", text });

  // é¡¯ç¤ºæ€è€ƒä¸­
  const thinking = renderMessage(
    "assistant",
    "â€¦ æ­£åœ¨æ€è€ƒä¸­",
    { thinking: true }
  );

  try {
    const form = new FormData();
    form.append("message", text);

    const res = await fetch(`${API_BASE_URL}/chat`, {
      method: "POST",
      body: form
    });

    if (!res.ok) {
      throw new Error(await res.text());
    }

    const data = await res.json();
    thinking.parentElement.remove();
    typeWriter(data.reply || "", "â€”");

  } catch (e) {
    thinking.textContent = "âŒ èªéŸ³è™•ç†å¤±æ•—";
    console.error(e);
  } finally {
    // â­ èªéŸ³æµç¨‹çµæŸæ‰ reset UI
    resetMicUI();
  }
}
 
  recog.onresult = e => {
    const text = e.results[0][0].transcript.trim();
    if (!text) return;
    smartSend(text);
  };

  // â›” ç™¼ç”ŸéŒ¯èª¤
  recog.onerror = e => {
    console.warn("Speech error:", e.error);
    if (e.error === "not-allowed" || e.error === "service-not-allowed") {
      alert("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™å¾Œå†ä½¿ç”¨èªéŸ³è¼¸å…¥");
    } else {
      alert("èªéŸ³è¾¨è­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡");
    }
    resetMicUI();
  };

recog.onend = () => {
  console.log("ğŸ¤ recognition ENDED");

  // âœ… å¦‚æœæ­£åœ¨ç­‰ä½¿ç”¨è€…èªªã€Œå° / å–æ¶ˆã€
  if (pendingVoiceAction) {
    console.log("â¸ waiting confirm, stop recognition");
    return;
  }
};

  
    
  } else {
    micBtn.disabled = true;
    micBtn.textContent = "ğŸ¤ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥";
  }


  /* =========================
     Load history (ä¿ç•™åŠŸèƒ½)
  ========================= */
  const historyData = JSON.parse(localStorage.getItem("chat_history") || "[]");
  historyData.forEach(m => {
    renderMessage(m.role, m.text);
    addHistoryLine(m);
  });

/* =========================
   Send message (æ”¯æ´å¤šæª”åœ–ç‰‡ / PDF)
========================= */
sendBtn.onclick = async () => {
  const text = inputEl.value.trim();
  const files = Array.from(fileInput.files); // â­ é—œéµ

  if (!text && files.length === 0) return;

  // UI
  const userLabel =
    text || `ğŸ—‚ å·²ä¸Šå‚³ ${files.length} å€‹æª”æ¡ˆ`;
  renderMessage("user", userLabel);

  saveHistory({
    role: "user",
    text: text || `[ä¸Šå‚³ ${files.length} å€‹æª”æ¡ˆ]`
  });

  let thinkingBubble;

  if (files.length > 0) {
    thinkingBubble = renderMessage(
      "assistant",
      `ğŸ“‚ æ­£åœ¨åˆ†æ ${files.length} å€‹æª”æ¡ˆï¼Œè«‹ç¨å€™â€¦`,
      { thinking: true }
    );
  } else {
    thinkingBubble = renderMessage(
      "assistant",
      "â€¦ æ­£åœ¨æ€è€ƒä¸­",
      { thinking: true }
    );
  }

  try {
    const form = new FormData();
    form.append("message", text);

    for (const file of files) {
      form.append("image", file); // åŒå key âœ”
    }

    const res = await fetch(`${API_BASE_URL}/chat`, {
      method: "POST",
      body: form,
    });

    if (!res.ok) {
      throw new Error(await res.text());
    }

    const data = await res.json();
    thinkingBubble.parentElement.remove();
    typeWriter(data.reply || "", "â€”");
    // ğŸŸ¢ è‹¥ AI å·²ç”¢ç”Ÿè«‹å‡ä¿¡ï¼Œé¡¯ç¤º Outlook å¯„ä¿¡æŒ‰éˆ•
    if (data.reply && data.reply.includes("è«‹å‡")) {
      renderMailAction({
        to: "boss@company.com",        // ğŸ‘‰ å…ˆå¯«æ­»ï¼Œä¹‹å¾Œå¯è®“ AI å›å‚³
        subject: "è«‹å‡ç”³è«‹",
        body: data.reply
      });
    }

  } catch (e) {
    thinkingBubble.textContent = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    console.error(e);
  } finally {
    // â­ æœ€å¾Œæ‰æ¸…
    inputEl.value = "";
    fileInput.value = "";
  }
};

  /* =========================
     Render
  ========================= */
  function renderMessage(role, text, options = {}) {
    const { imageUrl = null, thinking = false, tag = null } = options;

    const row = document.createElement("div");
    row.className = `message ${role}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    if (thinking) bubble.classList.add("thinking");

    // optional tag (AI)
    if (tag) {
      const t = document.createElement("div");
      t.className = "tag";
      t.innerHTML = `<span class="miniDot"></span> ${tag}`;
      bubble.appendChild(t);
    }

    const textNode = document.createElement("div");
    textNode.textContent = text;
    bubble.appendChild(textNode);

    if (imageUrl) {
      const img = document.createElement("img");
      img.src = imageUrl;
      img.className = "thumb";
      bubble.appendChild(img);
    }

    row.appendChild(bubble);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
    return bubble;
  }
  // =========================
  // ğŸ“§ é¡¯ç¤ºã€Œç”¨ Outlook å¯„å‡ºã€æŒ‰éˆ•
  // =========================
  function renderMailAction({ to, subject, body }) {
    const row = document.createElement("div");
    row.className = "message assistant";
  
    const bubble = document.createElement("div");
    bubble.className = "bubble";
  
    const textDiv = document.createElement("div");
    textDiv.textContent = "ğŸ“§ æˆ‘å·²å¹«ä½ æ•´ç†å¥½è«‹å‡ä¿¡ï¼Œè¦ç”¨ Outlook å¯„å‡ºå—ï¼Ÿ";
  
    const btn = document.createElement("button");
    btn.style.marginTop = "10px";
    btn.textContent = "ğŸ“§ ç”¨ Outlook å¯„å‡º";
    btn.onclick = () => {
      openOutlookMail({ to, subject, body });
    };
  
    bubble.appendChild(textDiv);
    bubble.appendChild(btn);
    row.appendChild(bubble);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function typeWriter(text, seconds) {
    let i = 0;

    const bubble = renderMessage("assistant", "", { tag: "AI Â· Reasoned Response" });

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `â± å›è¦†æ™‚é–“ç´„ ${seconds}s`;

    // typing
    const timer = setInterval(() => {
      // bubble çš„ç¬¬äºŒå€‹ child æ˜¯æ–‡å­—å®¹å™¨ï¼ˆtag + textDivï¼‰
      const textDiv = bubble.children[1];
      textDiv.textContent += text[i++] || "";

      chatEl.scrollTop = chatEl.scrollHeight;

      if (i >= text.length) {
        clearInterval(timer);
        bubble.appendChild(meta);

        if (voiceEnabled) speak(text);
        saveHistory({ role: "assistant", text });
      }
    }, 16);
  }

  /* =========================
     Sidebar history
  ========================= */
  function addHistoryLine({ role, text }) {
    const div = document.createElement("div");
    div.className = "sidebar-item";
    const prefix = role === "user" ? "USER" : "AI";
    div.textContent = `${prefix} Â· ${text}`;
    historyList.appendChild(div);
  }

  function saveHistory(entry) {
    const list = JSON.parse(localStorage.getItem("chat_history") || "[]");
    list.push(entry);
    localStorage.setItem("chat_history", JSON.stringify(list));
    addHistoryLine(entry);
  }

  /* =========================
     TTS
  ========================= */
  function speak(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel(); // é¿å…ç–ŠéŸ³
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    window.speechSynthesis.speak(u);
  }
// =========================
// ğŸ“§ é–‹å•Ÿ Outlook å¯„ä¿¡
// =========================
function openOutlookMail({ to, subject, body }) {
  const mailto =
    `mailto:${encodeURIComponent(to)}` +
    `?subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body.replace(/\n/g, "\r\n"))}`;

  // âœ… ç”¨ window.openï¼Œæ¯” location.href ç©©å®šéå¸¸å¤š
  window.open(mailto, "_self");
}

  function renderConfirmUI(text) {
  const row = document.createElement("div");
  row.className = "message assistant";

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const textDiv = document.createElement("div");
  textDiv.textContent = text;
  bubble.appendChild(textDiv);

  const btns = document.createElement("div");
  btns.style.marginTop = "10px";
  btns.style.display = "flex";
  btns.style.gap = "8px";

  const ok = document.createElement("button");
  ok.textContent = "âœ… ç¢ºèª";
  ok.onclick = confirmVoiceAction;

  const cancel = document.createElement("button");
  cancel.textContent = "âŒ å–æ¶ˆ";
  cancel.onclick = () => {
    pendingVoiceAction = null;
    renderMessage("assistant", "å¥½ï¼Œå·²å–æ¶ˆ ğŸ‘");
  };

  btns.appendChild(ok);
  btns.appendChild(cancel);
  bubble.appendChild(btns);

  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

async function confirmVoiceAction() {
  if (!pendingVoiceAction) return;

  try {
    const res = await fetch(`${API_BASE_URL}/voice-confirm`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(pendingVoiceAction)
    });
    const data = await res.json();
    renderMessage("assistant", data.reply);
  } catch (e) {
    renderMessage("assistant", "âŒ åŸ·è¡Œå¤±æ•—");
  } finally {
    pendingVoiceAction = null;
  }
}
</script>
</body>
</html>

























