<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI åŠ©ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-dark: linear-gradient(135deg, #020617, #0b1220);
      --bg-light: linear-gradient(135deg, #f8fafc, #e5e7eb);
      --glass-dark: rgba(15,15,20,0.9);
      --glass-light: rgba(255,255,255,0.95);
      --bubble-user: linear-gradient(135deg, #3b82f6, #2563eb);
      --bubble-ai-dark: rgba(31,41,55,0.97);
      --bubble-ai-light: rgba(255,255,255,1);
      --text-dark: #e5e7eb;
      --text-light: #0f172a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      overflow: hidden;
    }

    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    /* ğŸ”¥ æƒæç·š + ç»ç’ƒéœ§åŒ–å±¤ */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.03),
          rgba(255,255,255,0.03) 1px,
          transparent 2px,
          transparent 4px
        ),
        linear-gradient(
          to bottom,
          transparent 0%,
          rgba(255,255,255,0.12) 50%,
          transparent 100%
        );
      animation: scan 6s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes scan {
      from { background-position-y: -100%; }
      to   { background-position-y: 100%; }
    }

    /* å¤–å±¤æ’ç‰ˆ */
    .wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      z-index: 1;
    }

    /* ----- å´æ¬„ ----- */
    .sidebar {
      width: 260px;
      background: rgba(0,0,0,0.78);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(148,163,184,0.5);
      position: absolute;
      left: -260px;
      top: 0;
      bottom: 0;
      transition: left .35s ease;
      z-index: 20;
      display: flex;
      flex-direction: column;
      color: #e5e7eb;
    }

    body.light .sidebar {
      background: rgba(255,255,255,0.96);
      color: #0f172a;
    }

    .sidebar.show { left: 0; }

    .sidebar-header {
      padding: 14px 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(148,163,184,0.5);
    }

    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px;
      font-size: 13px;
      line-height: 1.5;
    }

    .sidebar-item {
      padding: 6px 8px;
      border-radius: 8px;
      margin-bottom: 4px;
      background: rgba(15,23,42,0.4);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    /* ----- ä¸»ä»‹é¢ ----- */
    .app {
      flex: 1;
      margin: 16px;
      border-radius: 24px;
      background: var(--glass-dark);
      backdrop-filter: blur(24px);
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: .3s ease;
    }

    .app.shift {
      margin-left: 276px;
    }

    body.light .app {
      background: var(--glass-light);
      box-shadow: 0 24px 60px rgba(15,23,42,0.25);
    }

    /* Header */
    .header {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(148,163,184,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
    }

    .header-right {
      display: flex;
      gap: 12px;
    }

    .toggle {
      cursor: pointer;
      font-size: 18px;
    }

    /* èŠå¤©å€ */
    .chat {
      flex: 1;
      padding: 18px;
      overflow-y: auto;
    }

    .message {
      display: flex;
      margin-bottom: 10px;
    }

    .user { justify-content: flex-end; }
    .assistant { justify-content: flex-start; }

    .bubble {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 14px;
      white-space: pre-wrap;
      animation: breathe 3s infinite;
    }

    .user .bubble {
      background: var(--bubble-user);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .assistant .bubble {
      background: var(--bubble-ai-dark);
      color: var(--text-dark);
      border-bottom-left-radius: 6px;
    }

    body.light .assistant .bubble {
      background: var(--bubble-ai-light);
      color: var(--text-light);
    }

    .thinking {
      opacity: 0.7;
      font-style: italic;
      animation: blink 1.4s infinite;
    }

    .thumb {
      margin-top: 6px;
      max-width: 160px;
      border-radius: 12px;
      display: block;
    }

    .meta {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 4px;
    }

    /* è¼¸å…¥å€ */
    .footer {
      padding: 12px 14px;
      border-top: 1px solid rgba(148,163,184,0.5);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .file-label {
      cursor: pointer;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    textarea {
      flex: 1;
      resize: none;
      padding: 10px 12px;
      border-radius: 12px;
      border: none;
      background: rgba(15,23,42,0.9);
      color: var(--text-dark);
      font-size: 14px;
    }

    body.light textarea {
      background: #f9fafb;
      color: #0f172a;
    }

    button {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      font-weight: 600;
    }

    @keyframes breathe {
      0% { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
      50% { box-shadow: 0 10px 26px rgba(0,0,0,0.6); }
      100% { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    }

    @keyframes blink {
      0% {opacity:0.3;} 50%{opacity:1;} 100%{opacity:0.3;}
    }
  </style>
</head>

<body>

<div class="wrapper">
  <!-- ===== å´é‚Šæ¬„ ===== -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <span>ğŸ“œ èŠå¤©è¨˜éŒ„</span>
      <span id="clearHistory" class="sidebar-clear">æ¸…é™¤</span>
    </div>
    <div id="historyList" class="sidebar-body"></div>
  </aside>

  <!-- ===== ä¸»ç•«é¢ ===== -->
  <main id="app" class="app">
    <header class="header">
      <span>âœ¨ AI åŠ©ç†</span>
      <div class="header-right">
        <span id="historyBtn" class="toggle">ğŸ“œ</span>
        <span id="themeBtn" class="toggle">ğŸŒ“</span>
        <span id="voiceBtn" class="toggle">ğŸ”ˆ</span>
      </div>
    </header>

    <section id="chat" class="chat"></section>

    <footer class="footer">
      <div class="input-row">
        <label class="file-label">
          ğŸ“
          <input type="file" id="fileInput" accept="image/*,.pdf">
        </label>
        <textarea id="input" rows="2" placeholder="è¼¸å…¥æ–‡å­—æˆ–èªéŸ³â€¦"></textarea>
      </div>
      <div class="controls">
        <button id="mic">ğŸ¤</button>
        <button id="send">é€å‡º</button>
      </div>
    </footer>
  </main>
</div>

<script>
const BASE_URL = "https://schedule-bot-production-32ae.up.railway.app";

const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const fileInput = document.getElementById("fileInput");
const sendBtn = document.getElementById("send");
const micBtn = document.getElementById("mic");
const themeBtn = document.getElementById("themeBtn");
const voiceBtn = document.getElementById("voiceBtn");

const sidebar = document.getElementById("sidebar");
const historyBtn = document.getElementById("historyBtn");
const clearHistoryBtn = document.getElementById("clearHistory");
const historyList = document.getElementById("historyList");
const appEl = document.getElementById("app");

/* ---- ä¸»é¡Œåˆ‡æ› ---- */
if (localStorage.getItem("theme") === "light") {
  document.body.classList.add("light");
}

themeBtn.onclick = () => {
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
};

/* ---- å´æ¬„ ---- */
historyBtn.onclick = () => {
  sidebar.classList.toggle("show");
  appEl.classList.toggle("shift");
};

clearHistoryBtn.onclick = () => {
  if (confirm("ç¢ºå®šæ¸…é™¤èŠå¤©è¨˜éŒ„ï¼Ÿ")) {
    localStorage.removeItem("chat_history");
    historyList.innerHTML = "";
    chatEl.innerHTML = "";
  }
};

/* ---- èªéŸ³é–±è®€ï¼ˆé è¨­ OFFï¼‰ ---- */
let voiceEnabled = false;

voiceBtn.textContent = voiceEnabled ? "ğŸ”‡" : "ğŸ”ˆ";

voiceBtn.onclick = () => {
  voiceEnabled = !voiceEnabled;
  voiceBtn.textContent = voiceEnabled ? "ğŸ”‡" : "ğŸ”ˆ";
};

/* ---- èªéŸ³è¼¸å…¥ ---- */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = SR ? new SR() : null;

if (recog) {
  recog.lang = "zh-TW";
  micBtn.onclick = () => recog.start();
  recog.onresult = e => {
    inputEl.value = e.results[0][0].transcript;
  };
} else {
  micBtn.disabled = true;
}

/* ---- æ­·å²è¨˜éŒ„è¼‰å…¥ ---- */
const historyData = JSON.parse(localStorage.getItem("chat_history") || "[]");

historyData.forEach(m => {
  renderMessage(m.role, m.text);
  addHistoryLine(m);
});

/* ---- ç™¼é€è¨Šæ¯ ---- */
sendBtn.onclick = async () => {
  const text = inputEl.value.trim();
  const file = fileInput.files[0];
  
  if (!text && !file) return;

  const preview = (file && file.type.startsWith("image/")) ? URL.createObjectURL(file) : null;
  renderMessage("user", text || `[æª”æ¡ˆ] ${file?.name || ""}`, { imageUrl: preview });

  saveHistory({ role: "user", text: text || `[æª”æ¡ˆ] ${file?.name}` });

  inputEl.value = "";
  const thinkingBubble = renderMessage("assistant", "â€¦ æ­£åœ¨æ€è€ƒä¸­", { thinking: true });

  try {
    const form = new FormData();
    form.append("message", text);
    if (file) form.append("image", file);

    const res = await fetch(`${BASE_URL}/chat`, { method: "POST", body: form });
    const data = await res.json();

    thinkingBubble.parentElement.remove();
    typeWriter(data.reply);
  } catch (e) {
    thinkingBubble.textContent = "âŒ éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
  } finally {
    fileInput.value = "";
  }
};

/* ---- æ¸²æŸ“è¨Šæ¯ ---- */
function renderMessage(role, text, options = {}) {
  const { imageUrl = null, thinking = false } = options;

  const row = document.createElement("div");
  row.className = `message ${role}`;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;

  if (thinking) bubble.classList.add("thinking");

  if (imageUrl) {
    const img = document.createElement("img");
    img.src = imageUrl;
    img.className = "thumb";
    bubble.appendChild(img);
  }

  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;

  return bubble;
}

/* ---- æ‰“å­—æ©Ÿæ•ˆæœ ---- */
function typeWriter(text) {
  let i = 0;
  const bubble = renderMessage("assistant", "");

  const timer = setInterval(() => {
    bubble.textContent += text[i++] || "";

    if (i >= text.length) {
      clearInterval(timer);

      if (voiceEnabled) speak(text);

      saveHistory({ role: "assistant", text });
    }

    chatEl.scrollTop = chatEl.scrollHeight;
  }, 18);
}

/* ---- ç´€éŒ„å´æ¬„ ---- */
function addHistoryLine({ role, text }) {
  const div = document.createElement("div");
  div.className = "sidebar-item";
  div.textContent = `${role === "user" ? "ğŸ§‘â€ğŸ’»" : "ğŸ¤–"} ${text}`;
  historyList.appendChild(div);
}

function saveHistory(entry) {
  const list = JSON.parse(localStorage.getItem("chat_history") || "[]");
  list.push(entry);
  localStorage.setItem("chat_history", JSON.stringify(list));
  addHistoryLine(entry);
}

/* ---- èªéŸ³ ---- */
function speak(text) {
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "zh-TW";
  speechSynthesis.speak(u);
}
</script>

</body>
</html>
