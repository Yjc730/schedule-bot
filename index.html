<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è¡Œäº‹æ›†èŠå¤©æ©Ÿå™¨äºº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
    }
    .app {
      background: #ffffff;
      margin: 16px;
      border-radius: 16px;
      max-width: 960px;
      width: 100%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      overflow: hidden;
    }
    .header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title {
      font-size: 18px;
      font-weight: 600;
    }
    .subtitle {
      font-size: 12px;
      color: #6b7280;
    }
    .header-right {
      font-size: 12px;
      color: #6b7280;
    }

    .chat {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f9fafb;
    }
    .message {
      display: flex;
      margin-bottom: 10px;
    }
    .message.user {
      justify-content: flex-end;
    }
    .bubble {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 14px;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .user .bubble {
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .assistant .bubble {
      background: #e5e7eb;
      color: #111827;
      border-bottom-left-radius: 4px;
    }
    .bubble .meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .footer {
      border-top: 1px solid #e5e7eb;
      padding: 8px 12px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .mode-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #6b7280;
      flex-wrap: wrap;
    }
    select {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }
    .file-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed #d1d5db;
      cursor: pointer;
      font-size: 11px;
      color: #6b7280;
    }
    .file-label span {
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-label.disabled {
      opacity: 0.4;
      cursor: default;
    }
    input[type="file"] {
      display: none;
    }

    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    textarea {
      flex: 1;
      resize: none;
      min-height: 50px;
      max-height: 120px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    button {
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: white;
      white-space: nowrap;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
    }
    .events-text {
      font-size: 13px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="title">è¡Œäº‹æ›†èŠå¤©æ©Ÿå™¨äºº</div>
        <div class="subtitle">åƒ ChatGPT ä¸€æ¨£èŠå¤©ï¼Œå¯åˆ‡æ›æ¨¡å¼è§£æè¡Œç¨‹</div>
      </div>
      <div class="header-right">
        å¾Œç«¯ï¼š<code>/chat</code> Â· <code>/parse-schedule-text</code> Â· <code>/parse-schedule-image</code>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="footer">
      <div class="mode-row">
        <div>
          æ¨¡å¼ï¼š
          <select id="mode">
            <option value="chat">ğŸ’¬ ä¸€èˆ¬èŠå¤©ï¼ˆLLMï¼‰</option>
            <option value="text">ğŸ—“ è§£ææ–‡å­—è¡Œç¨‹</option>
            <option value="image">ğŸ–¼ è§£æè¡Œäº‹æ›†åœ–ç‰‡</option>
          </select>
        </div>

        <label id="file-label" class="file-label">
          <span id="file-label-text">ğŸ“ ä¸Šå‚³åœ–ç‰‡ï¼ˆåƒ…åœ–ç‰‡æ¨¡å¼éœ€è¦ï¼‰</span>
          <input type="file" id="image-input" accept="image/*" />
        </label>
      </div>

      <div class="input-row">
        <textarea id="input" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒEnter æ›è¡Œï¼ŒCtrl+Enter / Cmd+Enter é€å‡º"></textarea>
        <button id="send">é€å‡º</button>
      </div>
      <div class="hint">
        ğŸ’¡ æç¤ºï¼š  
        ãƒ»èŠå¤©æ¨¡å¼æœƒç›´æ¥ call <code>/chat</code>ï¼ˆæ¥å¥½ LLM å°±èƒ½å°è©±ï¼‰  
        ãƒ»æ–‡å­—è¡Œç¨‹æ¨¡å¼æœƒ call <code>/parse-schedule-text</code> ä¸¦æŠŠå›å‚³çš„ events æ•´ç†æˆåˆ—è¡¨  
        ãƒ»åœ–ç‰‡æ¨¡å¼æœƒ call <code>/parse-schedule-image</code>ï¼ˆéœ€è¦é¸æ“‡ä¸€å¼µåœ–ç‰‡ï¼‰
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "http://localhost:8000";

    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const modeEl = document.getElementById("mode");
    const fileInput = document.getElementById("image-input");
    const fileLabel = document.getElementById("file-label");
    const fileLabelText = document.getElementById("file-label-text");

    function addMessage(role, content) {
      const msgEl = document.createElement("div");
      msgEl.className = `message ${role}`;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const inner = document.createElement("div");
      inner.textContent = content;

      bubble.appendChild(inner);
      msgEl.appendChild(bubble);
      chatEl.appendChild(msgEl);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addAssistantStructuredMessage(title, text) {
      const msgEl = document.createElement("div");
      msgEl.className = "message assistant";

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = title;

      const body = document.createElement("div");
      body.className = "events-text";
      body.textContent = text;

      bubble.appendChild(meta);
      bubble.appendChild(body);
      msgEl.appendChild(bubble);
      chatEl.appendChild(msgEl);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function formatEvents(events) {
      if (!events || events.length === 0) return "æ²’æœ‰è§£æå‡ºä»»ä½•è¡Œç¨‹ã€‚";
      return events.map((e, i) => {
        const time = (e.start_time || "") + (e.end_time ? " - " + e.end_time : "");
        const loc = e.location ? ` @ ${e.location}` : "";
        return `${i + 1}. ${e.date || ""} ${time}ï½œ${e.title || ""}${loc}`;
      }).join("\n");
    }

    function setImageModeEnabled(enabled) {
      if (enabled) {
        fileLabel.classList.remove("disabled");
      } else {
        fileLabel.classList.add("disabled");
      }
    }

    modeEl.addEventListener("change", () => {
      if (modeEl.value === "image") {
        setImageModeEnabled(true);
      } else {
        setImageModeEnabled(false);
        fileInput.value = "";
        fileLabelText.textContent = "ğŸ“ ä¸Šå‚³åœ–ç‰‡ï¼ˆåƒ…åœ–ç‰‡æ¨¡å¼éœ€è¦ï¼‰";
      }
    });

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) {
        fileLabelText.textContent = `ğŸ“ å·²é¸æ“‡ï¼š${file.name}`;
      } else {
        fileLabelText.textContent = "ğŸ“ ä¸Šå‚³åœ–ç‰‡ï¼ˆåƒ…åœ–ç‰‡æ¨¡å¼éœ€è¦ï¼‰";
      }
    });

    async function handleSend() {
      const mode = modeEl.value;
      const text = inputEl.value.trim();
      const file = fileInput.files[0];

      if (mode !== "image" && !text) return;
      if (mode === "image" && !file) {
        alert("è«‹å…ˆé¸æ“‡ä¸€å¼µåœ–ç‰‡ã€‚");
        return;
      }

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      if (mode === "image") {
        addMessage("user", text ? `ğŸ–¼ï¼ˆåœ–ç‰‡ï¼‹æ–‡å­—ï¼‰\n${text}` : "ğŸ–¼ ä¸Šå‚³äº†ä¸€å¼µåœ–ç‰‡");
      } else {
        addMessage("user", text);
      }

      inputEl.value = "";
      sendBtn.disabled = true;

      try {
        if (mode === "chat") {
          // ä¸€èˆ¬èŠå¤© â†’ /chat
          const resp = await fetch(`${BASE_URL}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              context: []
            }),
          });
          const data = await resp.json();
          addMessage("assistant", data.reply || JSON.stringify(data, null, 2));
        } else if (mode === "text") {
          // è§£ææ–‡å­—è¡Œç¨‹ â†’ /parse-schedule-text
          const body = {
            text: text,
            reference_date: null, // éœ€è¦å¯ä»¥åŠ  input è®“ä½¿ç”¨è€…é¸
          };
          const resp = await fetch(`${BASE_URL}/parse-schedule-text`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await resp.json();
          const summary = formatEvents(data.events || []);
          addAssistantStructuredMessage("è§£ææ–‡å­—è¡Œç¨‹çµæœ", summary);
        } else if (mode === "image") {
          // åœ–ç‰‡è¡Œç¨‹è§£æ â†’ /parse-schedule-image
          const form = new FormData();
          form.append("image", file);
          // å¦‚æœè¦ reference_dateï¼Œå¯ä»¥åœ¨ footer å†åŠ ä¸€å€‹ input
          const resp = await fetch(`${BASE_URL}/parse-schedule-image`, {
            method: "POST",
            body: form,
          });
          const data = await resp.json();
          const summary = formatEvents(data.events || []);
          addAssistantStructuredMessage("è§£æåœ–ç‰‡è¡Œç¨‹çµæœ", summary);
        }
      } catch (err) {
        console.error(err);
        addMessage("assistant", "âš ï¸ éŒ¯èª¤ï¼šç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ã€‚");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", handleSend);

    // Ctrl+Enter / Cmd+Enter é€å‡ºï¼ŒEnter æ›è¡Œ
    inputEl.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        handleSend();
      }
    });

    // åˆå§‹è¨Šæ¯
    addMessage(
      "assistant",
      "å—¨ï½æˆ‘æ˜¯è¡Œäº‹æ›†èŠå¤©æ©Ÿå™¨äºº ğŸ‘‹\n" +
      "ãƒ»é¸æ“‡ä¸Šæ–¹æ¨¡å¼å¾Œè¼¸å…¥è¨Šæ¯\n" +
      "ãƒ»èŠå¤©æ¨¡å¼æœƒç”¨ LLM å›è¦†\n" +
      "ãƒ»æ–‡å­—/åœ–ç‰‡æ¨¡å¼æœƒå¹«ä½ æ•´ç†æˆè¡Œç¨‹åˆ—è¡¨"
    );
    setImageModeEnabled(false);
  </script>
</body>
</html>
