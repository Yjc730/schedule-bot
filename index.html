<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI Âä©ÁêÜ ¬∑ AI Lab Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1220;
      --panel: rgba(15, 23, 42, 0.72);
      --panel2: rgba(2, 6, 23, 0.55);
      --border: rgba(148,163,184,0.28);
      --text:#e5e7eb;
      --muted: rgba(226,232,240,0.7);

      --aqua:#22d3ee;
      --violet:#a78bfa;
      --blue:#60a5fa;

      --userGrad: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.95));
      --aiBg: rgba(31,41,55,0.92);

      --shadow: 0 26px 90px rgba(0,0,0,0.55);
      --shadow2: 0 14px 40px rgba(0,0,0,0.35);

      --radius: 22px;
      --radius2: 16px;
    }

    /* Light theme */
    body.light{
      --bg0:#f8fafc;
      --bg1:#e5e7eb;
      --panel: rgba(255,255,255,0.72);
      --panel2: rgba(255,255,255,0.55);
      --border: rgba(15,23,42,0.12);
      --text:#0f172a;
      --muted: rgba(15,23,42,0.62);

      --aiBg: rgba(255,255,255,0.95);
      --shadow: 0 22px 70px rgba(15,23,42,0.12);
      --shadow2: 0 10px 28px rgba(15,23,42,0.10);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      overflow:hidden;
      background: radial-gradient(1200px 700px at 18% 20%, rgba(34,211,238,0.14), transparent 55%),
                  radial-gradient(1000px 650px at 85% 35%, rgba(167,139,250,0.13), transparent 55%),
                  linear-gradient(135deg, var(--bg0), var(--bg1));
    }

    /* Calm cyber layers (SLOW) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        linear-gradient(transparent 0%, rgba(255,255,255,0.05) 50%, transparent 100%),
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.025),
          rgba(255,255,255,0.025) 1px,
          transparent 2px,
          transparent 6px
        );
      opacity:0.45;
      animation: drift 22s linear infinite; /* ‚úÖ ÊÖ¢ÂæàÂ§ö */
      transform: translateZ(0);
    }

    body::after{
      content:"";
      position:fixed;
      inset:-20%;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(circle at 20% 25%, rgba(34,211,238,0.08), transparent 40%),
        radial-gradient(circle at 80% 35%, rgba(167,139,250,0.08), transparent 42%),
        radial-gradient(circle at 50% 80%, rgba(96,165,250,0.06), transparent 45%);
      filter: blur(18px);
      animation: breathe 16s ease-in-out infinite; /* ‚úÖ ÂæàÊüî */
      transform: translateZ(0);
      opacity: 0.7;
    }

    @keyframes drift{
      0%{ background-position-y: -60%; }
      100%{ background-position-y: 60%; }
    }
    @keyframes breathe{
      0%{ transform: translate3d(0,0,0) scale(1); opacity:0.62; }
      50%{ transform: translate3d(0,-8px,0) scale(1.02); opacity:0.75; }
      100%{ transform: translate3d(0,0,0) scale(1); opacity:0.62; }
    }

    .wrapper{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      z-index:1;
    }

    /* Sidebar */
    .sidebar{
      width: 290px;
      position:absolute;
      left:-290px;
      top:0; bottom:0;
      z-index:20;

      background: linear-gradient(180deg, rgba(2,6,23,0.72), rgba(2,6,23,0.55));
      border-right: 1px solid var(--border);
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow2);

      display:flex;
      flex-direction:column;
      transition: left .32s ease;
    }
    body.light .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.62));
    }
    .sidebar.show{ left:0; }

    .sidebar-header{
      padding: 14px 14px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid var(--border);
      gap:10px;
    }
    .sidebar-title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .sidebar-title .t1{
      font-weight: 700;
      letter-spacing: 0.3px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.04);
      width: fit-content;
    }
    body.light .pill{ background: rgba(15,23,42,0.03); }

    .sidebar-clear{
      cursor:pointer;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      user-select:none;
      transition: transform .12s ease, border-color .12s ease;
    }
    .sidebar-clear:hover{
      transform: translateY(-1px);
      border-color: rgba(34,211,238,0.35);
    }

    .sidebar-body{
      flex:1;
      overflow-y:auto;
      padding: 12px 12px 16px;
    }

    .sidebar-item{
      padding: 10px 10px;
      border-radius: 14px;
      margin-bottom: 8px;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(15,23,42,0.28);
      color: var(--text);
      font-size: 12.5px;
      line-height: 1.35;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      cursor: default;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    body.light .sidebar-item{ background: rgba(15,23,42,0.04); }
    .sidebar-item:hover{
      transform: translateY(-1px);
      border-color: rgba(167,139,250,0.35);
      background: rgba(15,23,42,0.34);
    }
    body.light .sidebar-item:hover{ background: rgba(15,23,42,0.06); }

    /* Main App */
    .app{
      flex:1;
      margin: 16px;
      border-radius: var(--radius);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(15,23,42,0.76), rgba(15,23,42,0.56));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(22px);
      display:flex;
      flex-direction:column;
      transition: margin-left .32s ease;
      position:relative;
    }
    body.light .app{
      background: linear-gradient(180deg, rgba(255,255,255,0.76), rgba(255,255,255,0.56));
    }
    .app.shift{ margin-left: 306px; }

    /* Subtle neon frame */
    .app::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: var(--radius);
      padding: 1px;
      background: linear-gradient(135deg,
        rgba(34,211,238,0.35),
        rgba(167,139,250,0.22),
        rgba(96,165,250,0.22)
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      opacity: 0.8;
    }

    /* Header (AI Lab Mode) */
    .header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .brand .title{
      font-weight: 800;
      letter-spacing: 0.3px;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width: 8px; height:8px;
      border-radius:999px;
      background: rgba(34,211,238,0.9);
      box-shadow: 0 0 0 3px rgba(34,211,238,0.12), 0 0 18px rgba(34,211,238,0.45);
      flex: 0 0 auto;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.03);
    }
    body.light .badge{ background: rgba(15,23,42,0.03); }

    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .toggle{
      cursor:pointer;
      user-select:none;
      width: 38px;
      height: 38px;
      display:grid;
      place-items:center;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.03);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      font-size: 18px;
    }
    body.light .toggle{ background: rgba(15,23,42,0.03); }
    .toggle:hover{
      transform: translateY(-1px);
      border-color: rgba(34,211,238,0.35);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.08);
    }
    .toggle.voice-on{
      border-color: rgba(34,211,238,0.45);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.12), 0 0 18px rgba(34,211,238,0.16);
    }

    /* Chat area */
    .chat{
      flex:1;
      padding: 18px 18px 8px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      position:relative;
    }

    .message{
      display:flex;
      margin-bottom: 12px;
      animation: pop .18s ease;
    }
    @keyframes pop{
      from{ opacity:0; transform: translateY(4px); }
      to{ opacity:1; transform:none; }
    }

    .user{ justify-content:flex-end; }
    .assistant{ justify-content:flex-start; }

    .bubble{
      max-width: 78%;
      padding: 12px 14px;
      border-radius: 18px;
      line-height: 1.65;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
      position:relative;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(15,23,42,0.35);
    }

    .user .bubble{
      background: var(--userGrad);
      color: #fff;
      border-bottom-right-radius: 8px;
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 14px 36px rgba(37,99,235,0.18);
    }

    .assistant .bubble{
      background: var(--aiBg);
      color: var(--text);
      border-bottom-left-radius: 8px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.22);
    }

    .bubble .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
      opacity: 0.85;
    }
    .tag .miniDot{
      width:6px;height:6px;border-radius:999px;
      background: rgba(167,139,250,0.9);
      box-shadow: 0 0 0 3px rgba(167,139,250,0.10);
    }

    .thinking{
      opacity: 0.78;
      font-style: italic;
      border-color: rgba(34,211,238,0.22) !important;
      box-shadow: 0 0 0 4px rgba(34,211,238,0.07);
      animation: blink 1.6s ease-in-out infinite;
    }
    @keyframes blink{
      0%,100%{ opacity:0.55; }
      50%{ opacity:0.95; }
    }

    .thumb{
      margin-top: 8px;
      border-radius: 14px;
      max-width: 180px;
      display:block;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 12px 30px rgba(0,0,0,0.22);
    }
    .meta{
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Footer */
    .footer{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
    }
    body.light .footer{
      background: linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.00));
    }

    .input-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .file-label{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      cursor:pointer;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.03);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
    }
    body.light .file-label{ background: rgba(15,23,42,0.03); }
    .file-label:hover{
      transform: translateY(-1px);
      border-color: rgba(167,139,250,0.35);
      box-shadow: 0 0 0 4px rgba(167,139,250,0.08);
    }
    input[type="file"]{ display:none; }

    textarea{
      flex:1;
      resize:none;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.22);
      outline:none;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
      background: rgba(2,6,23,0.30);
      backdrop-filter: blur(12px);
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    body.light textarea{
      background: rgba(255,255,255,0.72);
    }
    textarea.listening {
      border-color: rgba(34,211,238,0.55);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.15);
   }
    textarea:focus{
      border-color: rgba(34,211,238,0.40);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
    }

    .controls{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }

    button{
      flex:1;
      padding: 12px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.18);
      color: #fff;
      font-weight: 800;
      letter-spacing: .3px;
      cursor:pointer;
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.95));
      box-shadow: 0 14px 34px rgba(37,99,235,0.22);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(37,99,235,0.28);
    }
    button:disabled{
      opacity: 0.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    /* Mobile */
    @media (max-width: 768px){
      .app{ margin: 10px; border-radius: 18px; }
      .app.shift{ margin-left: 10px; } /* sidebar Ë¶ÜËìã */
      .sidebar{
        width: 86%;
        left: -86%;
      }
      .sidebar.show{ left:0; }
    }
  </style>
</head>

<body>
<div class="wrapper">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <div class="t1">Session Log <span class="pill">localStorage</span></div>
        <div class="pill">AI Lab Mode ¬∑ Calm Cyber</div>
      </div>
      <div id="clearHistory" class="sidebar-clear" title="Ê∏ÖÈô§ËÅäÂ§©Ë®òÈåÑ">Ê∏ÖÈô§</div>
    </div>
    <div id="historyList" class="sidebar-body"></div>
  </aside>

  <!-- Main -->
  <main id="app" class="app">
    <header class="header">
      <div class="brand">
        <div class="title"><span class="dot"></span> AI Assistant ¬∑ Lab</div>
        <div class="sub">
          <span class="badge">MODEL: Gemini 2.5 Flash</span>
          <span class="badge">STATUS: Online</span>
        </div>
      </div>

      <div class="header-right">
        <div id="historyBtn" class="toggle" title="Session Log">‚ò∞</div>
        <div id="themeBtn" class="toggle" title="Ê∑±Ëâ≤ / ‰∫ÆËâ≤">üåì</div>
        <div id="voiceBtn" class="toggle" title="Ë™ûÈü≥ÊúóËÆÄÔºàÈ†êË®≠ÈóúÈñâÔºâ">üîá</div>
      </div>
    </header>

    <section id="chat" class="chat"></section>

    <footer class="footer">
      <div class="input-row">
        <label class="file-label" title="‰∏äÂÇ≥ÂúñÁâá / PDF">
          üìé
          <input type="file" id="fileInput" accept="image/*,.pdf,application/pdf" />
        </label>
        <textarea id="input" rows="2" placeholder="Ëº∏ÂÖ•ÊñáÂ≠óÊàñÁî®Ë™ûÈü≥‚Ä¶ÔºàÊîØÊè¥ÂúñÁâá/PDFÔºâ"></textarea>
      </div>
      <div class="controls">
        <button id="mic" type="button">üé§ Ë™ûÈü≥Ëº∏ÂÖ•</button>
        <button id="send" type="button">ÈÄÅÂá∫</button>
      </div>
    </footer>
  </main>
</div>

<script>
  // üëâ Ë®òÂæóÊîπÊàê‰Ω†Ëá™Â∑±ÁöÑ Railway URL
  const API_BASE_URL = "https://schedule-bot-uzuu.onrender.com";
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const fileInput = document.getElementById("fileInput");

  const sendBtn = document.getElementById("send");
  const micBtn = document.getElementById("mic");

  const themeBtn = document.getElementById("themeBtn");
  const voiceBtn = document.getElementById("voiceBtn");
  const historyBtn = document.getElementById("historyBtn");

  const sidebar = document.getElementById("sidebar");
  const appEl = document.getElementById("app");
  const historyList = document.getElementById("historyList");
  const clearHistoryBtn = document.getElementById("clearHistory");

  let pendingVoiceAction = null;
  /* =========================
     Theme (‰øùÁïôÂäüËÉΩ)
  ========================= */
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
  }
  themeBtn.onclick = () => {
    document.body.classList.toggle("light");
    localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
  };

  /* =========================
     Sidebar (‰øùÁïôÂäüËÉΩ)
  ========================= */
  historyBtn.onclick = () => {
    sidebar.classList.toggle("show");
    appEl.classList.toggle("shift");
  };

  clearHistoryBtn.onclick = () => {
    if (!confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâËÅäÂ§©Ë®òÈåÑÂóéÔºü")) return;
    localStorage.removeItem("chat_history");
    historyList.innerHTML = "";
    chatEl.innerHTML = "";
  };

  /* =========================
     Voice TTS (Ê®°Âºè AÔºöÈ†êË®≠ÈóúÈñâÔºåÂè™ÊåâüîàÊâçÂî∏)
     ‚úÖ ÊúÉÂ≠ò localStorage
     ‚úÖ ÈóúÈñâÊôÇÊúÉ stop speak
  ========================= */
  let voiceEnabled = JSON.parse(localStorage.getItem("voice_enabled") || "false"); // ‚úÖ È†êË®≠ false
  function syncVoiceUI(){
    voiceBtn.textContent = voiceEnabled ? "üîà" : "üîá";
    voiceBtn.classList.toggle("voice-on", voiceEnabled);
    voiceBtn.title = voiceEnabled ? "Ë™ûÈü≥ÊúóËÆÄÔºöÈñã" : "Ë™ûÈü≥ÊúóËÆÄÔºöÈóúÔºàÈ†êË®≠Ôºâ";
  }
  syncVoiceUI();

  voiceBtn.onclick = () => {
    voiceEnabled = !voiceEnabled;
    localStorage.setItem("voice_enabled", JSON.stringify(voiceEnabled));
    if (!voiceEnabled && window.speechSynthesis) {
      window.speechSynthesis.cancel();
    }
    syncVoiceUI();
  };

  /* =========================
   Speech Recognition (Ë™ûÈü≥Ëº∏ÂÖ•)
========================= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = SR ? new SR() : null;
const defaultPlaceholder = inputEl.placeholder;


if (!navigator.mediaDevices || !recog) {
  micBtn.disabled = true;
  micBtn.textContent = "üé§ ‰∏çÊîØÊè¥Ë™ûÈü≥";
}
  
let isListening = false;
let lastTranscript = "";

function resetMicUI() {
  isListening = false;
  lastTranscript = "";

  micBtn.textContent = "üé§ Ë™ûÈü≥Ëº∏ÂÖ•";
  micBtn.classList.remove("voice-on");
  sendBtn.disabled = false;

  inputEl.placeholder = defaultPlaceholder;
  inputEl.classList.remove("listening");

  // ‚≠ê ÈóúÈçµÔºöÁ¢∫Ë™ç‰∏≠Â∞±‰∏çË¶ÅÈáçÁΩÆ
  if (pendingVoiceAction) return;
}



if (recog) {
  recog.lang = "zh-TW";
  recog.interimResults = false;
  recog.maxAlternatives = 1;

  // üé§ ÈªûÊìäÈ∫•ÂÖãÈ¢®ÔºöÈñãÂßã / ÂÅúÊ≠¢
  micBtn.onclick = () => {
    if (pendingVoiceAction) {
  renderMessage("assistant", "Ë´ãÁõ¥Êé•Ë™™„ÄåÂ∞ç„ÄçÊàñ„ÄåÂèñÊ∂à„Äç");
  return;
}
    if (!isListening) {
      try {
        recog.start();
        isListening = true;
        micBtn.textContent = "üõë ÂÅúÊ≠¢Ë™ûÈü≥";
        micBtn.classList.add("voice-on");
        sendBtn.disabled = true;   // ‚≠ê Êñ∞Â¢û

        // ‚≠ê Listening UI
        inputEl.placeholder = "üéô Listening‚Ä¶";
        inputEl.classList.add("listening");
        
      } catch (e) {
        console.warn("Speech start error", e);
      }
    } else {
      recog.stop();
    }
  };



  function isActionCommand(text){
    const keywords = [
      "ÂØÑ‰ø°", "Âπ´ÊàëÂØÑ", "ÂØ´‰ø°Áµ¶", "ÂØÑ‰∏ÄÂ∞Å‰ø°",
      "Èñãoutlook", "Èñã‰ø°"
    ];
    return keywords.some(k => text.includes(k));
  }
  
async function smartSend(text) {
  renderMessage("user", text);

  // =========================
  // ‚úÖ Â¶ÇÊûúÊ≠£Âú®Á≠âÁ¢∫Ë™ç
  // =========================
  if (pendingVoiceAction) {
    if (["Â∞ç", "Â•Ω", "Á¢∫Ë™ç", "ÊòØ"].some(k => text.includes(k))) {
      // üëâ ‰ΩøÁî®ËÄÖÁ¢∫Ë™ç
      try {
        const res = await fetch(`${API_BASE_URL}/voice-confirm`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(pendingVoiceAction)
        });
        const data = await res.json();
        renderMessage("assistant", data.reply);
      } catch (e) {
        renderMessage("assistant", "‚ùå Á¢∫Ë™çÂ§±Êïó");
      }
      pendingVoiceAction = null;
      return;
    }

    if (["ÂèñÊ∂à", "‰∏çË¶Å", "ÁÆó‰∫Ü"].some(k => text.includes(k))) {
      renderMessage("assistant", "‚ùå Â∑≤ÂèñÊ∂àÊìç‰Ωú");
      pendingVoiceAction = null;
      return;
    }

    // ÂÖ∂‰ªñË©± ‚Üí ÊèêÈÜí
    renderMessage("assistant", "Ë´ãÂõûÁ≠î„ÄåÂ∞ç„ÄçÊàñ„ÄåÂèñÊ∂à„Äç");
    return;
  }

  // =========================
  // ‰∏ÄËà¨Ë™ûÈü≥ÊµÅÁ®ã
  // =========================
  try {
    const res = await fetch(`${API_BASE_URL}/voice-command`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });
    const data = await res.json();

    renderMessage("assistant", data.reply);

    // ‚≠ê Â¶ÇÊûúÈúÄË¶ÅÁ¢∫Ë™ç ‚Üí Â≠òËµ∑‰æÜ
    if (data.need_confirm) {
      pendingVoiceAction = {
        action: data.action,
        slots: data.slots
      };
    }

  } catch (err) {
    renderMessage("assistant", "‚ùå Ë™ûÈü≥Êåá‰ª§ËôïÁêÜÂ§±Êïó");
  }
}

  
  recog.onresult = e => {
    const text = e.results[0][0].transcript.trim();
    if (!text || text === lastTranscript) return;
  
    lastTranscript = text;
    smartSend(text);
  };

  // ‚õî ÁôºÁîüÈåØË™§
  recog.onerror = e => {
    console.warn("Speech error:", e.error);
    if (e.error === "not-allowed" || e.error === "service-not-allowed") {
      alert("Ë´ãÂÖÅË®±È∫•ÂÖãÈ¢®Ê¨äÈôêÂæåÂÜç‰ΩøÁî®Ë™ûÈü≥Ëº∏ÂÖ•");
    } else {
      alert("Ë™ûÈü≥Ëæ®Ë≠òÂ§±ÊïóÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°");
    }
    resetMicUI();
  };

  // ‚úÖ ÁµêÊùüÁõ£ËÅΩ
  recog.onend = () => {
    resetMicUI();
  };

} else {
  micBtn.disabled = true;
  micBtn.textContent = "üé§ Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•";
}


  /* =========================
     Load history (‰øùÁïôÂäüËÉΩ)
  ========================= */
  const historyData = JSON.parse(localStorage.getItem("chat_history") || "[]");
  historyData.forEach(m => {
    renderMessage(m.role, m.text);
    addHistoryLine(m);
  });

  /* =========================
     Send message (ÂúñÁâá / PDF ‰ªçÁî® image ÂèÉÊï∏ÂêçÔºå‰∏çÁ†¥Â£ûÂæåÁ´Ø)
  ========================= */
  sendBtn.onclick = async () => {
    const text = inputEl.value.trim();
    const file = fileInput.files[0];

    if (!text && !file) return;

    const preview = (file && file.type && file.type.startsWith("image/"))
      ? URL.createObjectURL(file)
      : null;

    // UI: user message
    const userLabel = text || (file ? `üóÇ ‰∏äÂÇ≥Ê™îÊ°àÔºö${file.name}` : "");
    renderMessage("user", userLabel, { imageUrl: preview });

    // history
    saveHistory({ role: "user", text: text || (file ? `[Ê™îÊ°à] ${file.name}` : "") });

    inputEl.value = "";
    const thinkingBubble = renderMessage("assistant", "‚Ä¶ Ê≠£Âú®ÊÄùËÄÉ‰∏≠", { thinking: true });

    const startTime = performance.now();

    try {
      const form = new FormData();
      form.append("message", text);
      if (file) form.append("image", file); // ‚úÖ ÂæåÁ´Ø‰ªçÂè´ imageÔºàÂèØÁÇ∫ÂúñÁâáÊàñ PDFÔºâ

      const res = await fetch(`${API_BASE_URL}/chat`, {
  method: "POST",
  body: form,
});

    if (!res.ok) {
      const err = await res.text();
      throw new Error(err || res.statusText);
        }

      const data = await res.json(); 
      const replyText = (data && data.reply) ? data.reply : "";
      const cost = ((performance.now() - startTime) / 1000).toFixed(2);

      // remove thinking
      thinkingBubble.parentElement.remove();

      // AI tag + typewriter + meta
      typeWriter(replyText, cost);

    } catch (e) {
      console.error(e);
      thinkingBubble.textContent = "‚ùå ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶";
    } finally {
      fileInput.value = "";
    }
  };

  /* =========================
     Render
  ========================= */
  function renderMessage(role, text, options = {}) {
    const { imageUrl = null, thinking = false, tag = null } = options;

    const row = document.createElement("div");
    row.className = `message ${role}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    if (thinking) bubble.classList.add("thinking");

    // optional tag (AI)
    if (tag) {
      const t = document.createElement("div");
      t.className = "tag";
      t.innerHTML = `<span class="miniDot"></span> ${tag}`;
      bubble.appendChild(t);
    }

    const textNode = document.createElement("div");
    textNode.textContent = text;
    bubble.appendChild(textNode);

    if (imageUrl) {
      const img = document.createElement("img");
      img.src = imageUrl;
      img.className = "thumb";
      bubble.appendChild(img);
    }

    row.appendChild(bubble);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
    return bubble;
  }

  function typeWriter(text, seconds) {
    let i = 0;

    const bubble = renderMessage("assistant", "", { tag: "AI ¬∑ Reasoned Response" });

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `‚è± ÂõûË¶ÜÊôÇÈñìÁ¥Ñ ${seconds}s`;

    // typing
    const timer = setInterval(() => {
      // bubble ÁöÑÁ¨¨‰∫åÂÄã child ÊòØÊñáÂ≠óÂÆπÂô®Ôºàtag + textDivÔºâ
      const textDiv = bubble.children[1];
      textDiv.textContent += text[i++] || "";

      chatEl.scrollTop = chatEl.scrollHeight;

      if (i >= text.length) {
        clearInterval(timer);
        bubble.appendChild(meta);

        if (voiceEnabled) speak(text);
        saveHistory({ role: "assistant", text });
      }
    }, 16);
  }

  /* =========================
     Sidebar history
  ========================= */
  function addHistoryLine({ role, text }) {
    const div = document.createElement("div");
    div.className = "sidebar-item";
    const prefix = role === "user" ? "USER" : "AI";
    div.textContent = `${prefix} ¬∑ ${text}`;
    historyList.appendChild(div);
  }

  function saveHistory(entry) {
    const list = JSON.parse(localStorage.getItem("chat_history") || "[]");
    list.push(entry);
    localStorage.setItem("chat_history", JSON.stringify(list));
    addHistoryLine(entry);
  }

  /* =========================
     TTS
  ========================= */
  function speak(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel(); // ÈÅøÂÖçÁñäÈü≥
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    window.speechSynthesis.speak(u);
  }
  function renderConfirmUI(text) {
  const row = document.createElement("div");
  row.className = "message assistant";

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const textDiv = document.createElement("div");
  textDiv.textContent = text;
  bubble.appendChild(textDiv);

  const btns = document.createElement("div");
  btns.style.marginTop = "10px";
  btns.style.display = "flex";
  btns.style.gap = "8px";

  const ok = document.createElement("button");
  ok.textContent = "‚úÖ Á¢∫Ë™ç";
  ok.onclick = confirmVoiceAction;

  const cancel = document.createElement("button");
  cancel.textContent = "‚ùå ÂèñÊ∂à";
  cancel.onclick = () => {
    pendingVoiceAction = null;
    renderMessage("assistant", "Â•ΩÔºåÂ∑≤ÂèñÊ∂à üëç");
  };

  btns.appendChild(ok);
  btns.appendChild(cancel);
  bubble.appendChild(btns);

  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

async function confirmVoiceAction() {
  if (!pendingVoiceAction) return;

  try {
    const res = await fetch(`${API_BASE_URL}/voice-confirm`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(pendingVoiceAction)
    });
    const data = await res.json();
    renderMessage("assistant", data.reply);
  } catch (e) {
    renderMessage("assistant", "‚ùå Âü∑Ë°åÂ§±Êïó");
  } finally {
    pendingVoiceAction = null;
  }
}
</script>
</body>
</html>











