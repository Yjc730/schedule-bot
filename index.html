<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI åŠ©ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-dark: linear-gradient(135deg, #020617, #0f172a);
      --bg-light: linear-gradient(135deg, #f8fafc, #e5e7eb);
      --glass-dark: rgba(15,15,20,0.9);
      --glass-light: rgba(255,255,255,0.9);
      --bubble-user: linear-gradient(135deg, #3b82f6, #2563eb);
      --bubble-ai-dark: rgba(31,41,55,0.95);
      --bubble-ai-light: rgba(255,255,255,0.98);
      --text-dark: #e5e7eb;
      --text-light: #0f172a;
    }

    body {
      margin: 0;
      height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      overflow: hidden;
    }
    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    /* ğŸ”¥ æƒæç·š + ç»ç’ƒé›œè¨Šç§‘æŠ€å±¤ */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background:
        /* æ©«å‘æƒæç·š */
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.03),
          rgba(255,255,255,0.03) 1px,
          transparent 2px,
          transparent 4px
        ),
        /* æŸ”å’Œå…‰æŸ */
        linear-gradient(
          to bottom,
          transparent 0%,
          rgba(255,255,255,0.12) 50%,
          transparent 100%
        );
      animation: scan 6s linear infinite;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes scan {
      from { background-position-y: -100%; }
      to   { background-position-y: 100%; }
    }

    /* === ç‰ˆé¢ === */
    .wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      z-index: 1;
    }

    /* ğŸ“œ å´é‚ŠèŠå¤©ç´€éŒ„ */
    .sidebar {
      width: 280px;
      background: rgba(0,0,0,0.78);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(148,163,184,0.5);
      position: absolute;
      left: -280px;
      top: 0;
      bottom: 0;
      transition: left .35s ease;
      z-index: 20;
      display: flex;
      flex-direction: column;
      color: #e5e7eb;
    }
    body.light .sidebar {
      background: rgba(255,255,255,0.9);
      color: #0f172a;
      border-right: 1px solid rgba(148,163,184,0.5);
    }
    .sidebar.show {
      left: 0;
    }
    .sidebar-header {
      padding: 14px 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(148,163,184,0.5);
    }
    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px;
      font-size: 13px;
      line-height: 1.5;
    }
    .sidebar-item {
      padding: 6px 8px;
      border-radius: 8px;
      margin-bottom: 4px;
      background: rgba(15,23,42,0.4);
      cursor: default;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    body.light .sidebar-item {
      background: rgba(148,163,184,0.15);
    }
    .sidebar-clear {
      cursor: pointer;
      font-size: 12px;
      opacity: 0.8;
    }

    /* ğŸ’¬ ä¸»èŠå¤©å®¤ */
    .app {
      flex: 1;
      margin: 16px;
      border-radius: 24px;
      background: var(--glass-dark);
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
      backdrop-filter: blur(24px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: margin-left .35s ease, background .2s ease;
    }
    body.light .app {
      background: var(--glass-light);
      box-shadow: 0 24px 60px rgba(15,23,42,0.25);
    }
    .app.shift {
      margin-left: 296px;
    }

    /* Header */
    .header {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(148,163,184,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
    }
    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .toggle {
      cursor: pointer;
      font-size: 18px;
      user-select: none;
    }

    /* èŠå¤©åˆ—è¡¨ */
    .chat {
      flex: 1;
      padding: 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .message {
      display: flex;
      margin-bottom: 10px;
      animation: fadeIn .25s ease;
    }
    .user { justify-content: flex-end; }
    .assistant { justify-content: flex-start; }

    .bubble {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 14px;
      animation: breathe 3s infinite;
      position: relative;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .user .bubble {
      background: var(--bubble-user);
      color: #fff;
      border-bottom-right-radius: 6px;
      box-shadow: 0 8px 24px rgba(37,99,235,0.5);
    }
    .assistant .bubble {
      background: var(--bubble-ai-dark);
      color: var(--text-dark);
      border-bottom-left-radius: 6px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    body.light .assistant .bubble {
      background: var(--bubble-ai-light);
      color: var(--text-light);
      box-shadow: 0 8px 24px rgba(15,23,42,0.25);
    }

    .thinking {
      opacity: .7;
      font-style: italic;
      animation: blink 1.4s infinite;
    }

    .thumb {
      margin-top: 6px;
      border-radius: 12px;
      max-width: 160px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      display: block;
    }

    .meta {
      font-size: 11px;
      opacity: .6;
      margin-top: 4px;
    }

    /* è¼¸å…¥å€ */
    .footer {
      padding: 12px 14px;
      border-top: 1px solid rgba(148,163,184,0.5);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .file-label {
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: .9;
      white-space: nowrap;
    }
    .file-label span {
      text-decoration: underline;
    }
    input[type="file"] {
      display: none;
    }
    textarea {
      flex: 1;
      resize: none;
      padding: 10px 12px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      outline: none;
    }
    body.light textarea {
      background: rgba(248,250,252,1);
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    button {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(37,99,235,0.55);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(37,99,235,0.7);
    }
    button:disabled {
      opacity: .5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* å‹•ç•« */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: none; }
    }
    @keyframes breathe {
      0% { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
      50% { box-shadow: 0 10px 26px rgba(0,0,0,0.6); }
      100% { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    }
    @keyframes blink {
      0% { opacity:.3; } 50% { opacity:1; } 100% { opacity:.3; }
    }

    @media (max-width: 768px) {
      .app {
        margin: 8px;
        border-radius: 18px;
      }
      .app.shift {
        margin-left: 0; /* æ‰‹æ©Ÿä¸Šå´æ¬„ç›´æ¥è“‹åœ¨ä¸Šé¢å°±å¥½ */
      }
      .sidebar {
        width: 80%;
        left: -80%;
      }
      .sidebar.show {
        left: 0;
      }
    }
  </style>
</head>
<body>
<div class="wrapper">
  <!-- ğŸ“œ å´é‚ŠèŠå¤©ç´€éŒ„ -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <span>ğŸ“œ èŠå¤©è¨˜éŒ„</span>
      <span id="clearHistory" class="sidebar-clear">æ¸…é™¤</span>
    </div>
    <div id="historyList" class="sidebar-body"></div>
  </aside>

  <!-- ğŸ’¬ ä¸»èŠå¤©å®¤ -->
  <main id="app" class="app">
    <header class="header">
      <span>âœ¨ AI åŠ©ç†</span>
      <div class="header-right">
        <span id="historyBtn" class="toggle" title="åˆ‡æ›èŠå¤©è¨˜éŒ„">ğŸ“œ</span>
        <span id="themeBtn" class="toggle" title="åˆ‡æ›æ·±è‰² / äº®è‰²">ğŸŒ“</span>
      </div>
    </header>

    <section id="chat" class="chat"></section>

    <footer class="footer">
      <div class="input-row">
        <label class="file-label">
          ğŸ“
          <span>åœ–ç‰‡</span>
          <input type="file" id="imageInput" accept="image/*" />
        </label>
        <textarea id="input" rows="2" placeholder="è¼¸å…¥æ–‡å­—æˆ–ç”¨èªéŸ³â€¦"></textarea>
      </div>
      <div class="controls">
        <button id="mic">ğŸ¤</button>
        <button id="send">é€å‡º</button>
      </div>
    </footer>
  </main>
</div>

<script>
  const BASE_URL = "https://schedule-bot-production-32ae.up.railway.app";

  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const micBtn = document.getElementById("mic");
  const imageInput = document.getElementById("imageInput");

  const themeBtn = document.getElementById("themeBtn");
  const historyBtn = document.getElementById("historyBtn");
  const sidebar = document.getElementById("sidebar");
  const appEl = document.getElementById("app");
  const historyList = document.getElementById("historyList");
  const clearHistoryBtn = document.getElementById("clearHistory");

  /* ========= ä¸»é¡Œåˆ‡æ› ========= */
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
  }
  themeBtn.onclick = () => {
    document.body.classList.toggle("light");
    const mode = document.body.classList.contains("light") ? "light" : "dark";
    localStorage.setItem("theme", mode);
  };

  /* ========= å´æ¬„é–‹é—œ ========= */
  historyBtn.onclick = () => {
    sidebar.classList.toggle("show");
    appEl.classList.toggle("shift");
  };

  clearHistoryBtn.onclick = () => {
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è¨˜éŒ„å—ï¼Ÿ")) return;
    localStorage.removeItem("chat_history");
    historyList.innerHTML = "";
  };

  /* ========= LocalStorageï¼šè¼‰å…¥èˆŠç´€éŒ„ ========= */
  const historyData = JSON.parse(localStorage.getItem("chat_history") || "[]");
  historyData.forEach(m => {
    renderMessage(m.role, m.text);
    addHistoryLine(m);
  });

  /* ========= èªéŸ³è¼¸å…¥ ========= */
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recog = SR ? new SR() : null;
  if (recog) {
    recog.lang = "zh-TW";
    micBtn.onclick = () => recog.start();
    recog.onresult = e => {
      inputEl.value = e.results[0][0].transcript;
    };
  } else {
    micBtn.disabled = true;
  }

  /* ========= é€å‡ºè¨Šæ¯ ========= */
  sendBtn.onclick = async () => {
    const text = inputEl.value.trim();
    const file = imageInput.files[0];

    if (!text && !file) return;

    // ä½¿ç”¨è€…è¨Šæ¯ï¼šæ–‡å­— +ï¼ˆå¯é¸ï¼‰åœ–ç‰‡ç¸®åœ–
    const previewUrl = file ? URL.createObjectURL(file) : null;
    renderMessage("user", text || "ğŸ–¼ ä¸Šå‚³äº†ä¸€å¼µåœ–ç‰‡", { imageUrl: previewUrl });
    saveHistory({ role: "user", text: text || "[åœ–ç‰‡]" });

    inputEl.value = "";
    imageInput.value = "";

    // æ‰“å­—ä¸­å‹•ç•«
    const thinkingBubble = renderMessage("assistant", "â€¦ æ­£åœ¨æ€è€ƒä¸­", { thinking: true });
    const startTime = performance.now();

    try {
      let replyText = "";

      if (file) {
        // åœ–ç‰‡è§£æ
        const form = new FormData();
        form.append("image", file);
        const res = await fetch(`${BASE_URL}/parse-schedule-image`, {
          method: "POST",
          body: form
        });
        const data = await res.json();
        replyText = JSON.stringify(data, null, 2);
      } else {
        // ä¸€èˆ¬æ–‡å­—èŠå¤©
        const res = await fetch(`${BASE_URL}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        replyText = data.reply;
      }

      const cost = ((performance.now() - startTime) / 1000).toFixed(2);

      // æ›æˆé€å­—æ‰“å­—æ•ˆæœ
      thinkingBubble.parentElement.remove();
      typeWriter(replyText, cost);
    } catch (err) {
      console.error(err);
      thinkingBubble.textContent = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
  };

  /* ========= Render / Typewriter ========= */
  function renderMessage(role, text, options = {}) {
    const { thinking = false, imageUrl = null } = options;

    const item = document.createElement("div");
    item.className = `message ${role}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    if (thinking) bubble.classList.add("thinking");
    bubble.textContent = text;

    if (imageUrl) {
      const img = document.createElement("img");
      img.src = imageUrl;
      img.className = "thumb";
      bubble.appendChild(img);
    }

    item.appendChild(bubble);
    chatEl.appendChild(item);
    chatEl.scrollTop = chatEl.scrollHeight;
    return bubble;
  }

  function typeWriter(text, seconds) {
    let i = 0;
    const bubble = renderMessage("assistant", "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `â± å›è¦†æ™‚é–“ç´„ ${seconds}s`;

    const timer = setInterval(() => {
      bubble.textContent += text[i++] || "";
      chatEl.scrollTop = chatEl.scrollHeight;
      if (i >= text.length) {
        clearInterval(timer);
        bubble.appendChild(meta);
        speak(text);
        saveHistory({ role: "assistant", text });
      }
    }, 18);
  }

  /* ========= æ­·å²å´æ¬„ ========= */
  function addHistoryLine({ role, text }) {
    const div = document.createElement("div");
    div.className = "sidebar-item";
    const prefix = role === "user" ? "ğŸ§‘â€ğŸ’»" : "ğŸ¤–";
    div.textContent = `${prefix} ${text}`;
    historyList.appendChild(div);
  }

  function saveHistory(entry) {
    const data = JSON.parse(localStorage.getItem("chat_history") || "[]");
    data.push(entry);
    localStorage.setItem("chat_history", JSON.stringify(data));
    addHistoryLine(entry);
  }

  /* ========= èªéŸ³æœ—è®€ ========= */
  function speak(text) {
    if (!window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    speechSynthesis.speak(u);
  }
</script>
</body>
</html>
